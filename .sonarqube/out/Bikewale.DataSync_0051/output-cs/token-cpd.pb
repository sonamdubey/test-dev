™•
BD:\work\bikewaleweb\Bikewale.DataSync\DataSync\DataSyncConsumer.cs
	namespace 	
DataSync
 
{ 
internal 
class 
DataSyncConsumer #
{ 
private 
string 

_queueName !
,! "
	_hostName# ,
;, -
private 
readonly 
string 
_applicationName  0
,0 1
_retryCount2 =
,= >
_RabbitMsgTTL? L
,L M
_BWConnectionStringM `
,` a
_CWConnectionStringa t
;t u
private 
IConnection 
_connetionRabbitMq .
;. /
private 
IModel 
_model 
; 
private !
QueueingBasicConsumer %
consumer& .
;. /
public$$ 
DataSyncConsumer$$ 
($$  
)$$  !
{%% 	

_queueName&& 
=&& 
String&& 
.&&  
Format&&  &
(&&& '
$str&&' ;
,&&; < 
ConfigurationManager&&= Q
.&&Q R
AppSettings&&R ]
[&&] ^
$str&&^ i
]&&i j
.&&j k
ToUpper&&k r
(&&r s
)&&s t
)&&t u
;&&u v
	_hostName'' 
='' 
CreateConnection'' (
.''( )
nodes'') .
[''. /
(''/ 0
new''0 3
Random''4 :
('': ;
)''; <
)''< =
.''= >
Next''> B
(''B C
CreateConnection''C S
.''S T
nodes''T Y
.''Y Z
Count''Z _
)''_ `
]''` a
;''a b
_BWConnectionString(( 
=((  ! 
ConfigurationManager((" 6
.((6 7
AppSettings((7 B
[((B C
$str((C W
]((W X
;((X Y
_CWConnectionString)) 
=))  ! 
ConfigurationManager))" 6
.))6 7
AppSettings))7 B
[))B C
$str))C \
]))\ ]
;))] ^
SendMail** 
.** 
APPLICATION**  
=**! "
_applicationName**# 3
=**4 5
Convert**6 =
.**= >
ToString**> F
(**F G 
ConfigurationManager**G [
.**[ \
AppSettings**\ g
[**g h
$str**h v
]**v w
)**w x
;**x y
_retryCount++ 
=++  
ConfigurationManager++ .
.++. /
AppSettings++/ :
[++: ;
$str++; G
]++G H
;++H I
_RabbitMsgTTL,, 
=,,  
ConfigurationManager,, 0
.,,0 1
AppSettings,,1 <
[,,< =
$str,,= K
],,K L
;,,L M
InitConsumer-- 
(-- 
)-- 
;-- 
}.. 	
private44 
void44 
InitConsumer44 !
(44! "
)44" #
{55 	
try66 
{77 
CreateConnection99  
.99  !
Connect99! (
(99( )

_queueName99) 3
,993 4
	_hostName995 >
)99> ?
;99? @
_connetionRabbitMq:: "
=::# $
CreateConnection::% 5
.::5 6

Connection::6 @
;::@ A
if;; 
(;; 
_connetionRabbitMq;; &
!=;;' )
null;;* .
);;. /
{<< 
CreateConnection== $
.==$ %
CreateChannel==% 2
(==2 3
)==3 4
;==4 5
_model>> 
=>> 
CreateConnection>> -
.>>- .
Model>>. 3
;>>3 4
if?? 
(?? 
_model?? 
==?? !
null??" &
)??& '
{@@ 
SendMailAA  
.AA  !
HandleExceptionAA! 0
(AA0 1
newAA1 4
	ExceptionAA5 >
(AA> ?
$strAA? O
)AAO P
,AAP Q
StringAAR X
.AAX Y
FormatAAY _
(AA_ `
$strAA` w
,AAw x
_applicationName	AAy â
)
AAâ ä
)
AAä ã
;
AAã å
}BB 
elseCC 
{DD 
consumerEE  
=EE! "
CreateConnectionEE# 3
.EE3 4
CreateConsumerEE4 B
(EEB C
)EEC D
;EED E
ifFF 
(FF 
consumerFF $
==FF% '
nullFF( ,
)FF, -
{GG 
SendMailHH $
.HH$ %
HandleExceptionHH% 4
(HH4 5
newHH5 8
	ExceptionHH9 B
(HHB C
$strHHC p
)HHp q
,HHq r
StringHHs y
.HHy z
Format	HHz Ä
(
HHÄ Å
$str
HHÅ ò
,
HHò ô
_applicationName
HHö ™
)
HH™ ´
)
HH´ ¨
;
HH¨ ≠
}II 
elseJJ 
{KK 
consumerLL $
.LL$ %
ConsumerCancelledLL% 6
+=LL7 9&
consumer_ConsumerCancelledLL: T
;LLT U
}MM 
}NN 
}OO 
elsePP 
{QQ 
SendMailRR 
.RR 
HandleExceptionRR ,
(RR, -
newRR- 0
	ExceptionRR1 :
(RR: ;
$strRR; W
)RRW X
,RRX Y
StringRRZ `
.RR` a
FormatRRa g
(RRg h
$strRRh 
,	RR Ä
_applicationName
RRÅ ë
)
RRë í
)
RRí ì
;
RRì î
}SS 
}TT 
catchUU 
(UU 
	ExceptionUU 
exUU 
)UU  
{VV 
SendMailWW 
.WW 
HandleExceptionWW (
(WW( )
exWW) +
,WW+ ,
StringWW- 3
.WW3 4
FormatWW4 :
(WW: ;
$strWW; a
,WWa b
_applicationNameWWc s
)WWs t
)WWt u
;WWu v
}XX 
}YY 	
internal__ 
void__ 
ProcessQueries__ $
(__$ %
)__% &
{`` 	
whilebb 
(bb 
truebb 
)bb 
{cc 
Logsdd 
.dd 
WriteInfoLogdd !
(dd! "
$strdd" G
)ddG H
;ddH I
tryee 
{ff 
RabbitMQgg 
.gg 
Clientgg #
.gg# $
Eventsgg$ *
.gg* +!
BasicDeliverEventArgsgg+ @
deliverEventArgsggA Q
=ggR S
(ggT U
RabbitMQggU ]
.gg] ^
Clientgg^ d
.ggd e
Eventsgge k
.ggk l"
BasicDeliverEventArgs	ggl Å
)
ggÅ Ç
consumer
ggÇ ä
.
ggä ã
Queue
ggã ê
.
ggê ë
Dequeue
ggë ò
(
ggò ô
)
ggô ö
;
ggö õ
IBasicPropertieshh $
propshh% *
=hh+ ,
deliverEventArgshh- =
.hh= >
BasicPropertieshh> M
;hhM N
NameValueCollectionjj '
nvcjj( +
=jj, -
thisjj. 2
.jj2 3
ByteArrayToObjectjj3 D
(jjD E
deliverEventArgsjjE U
.jjU V
BodyjjV Z
)jjZ [
;jj[ \
stringkk 
dBNamekk !
=kk" #
nvckk$ '
[kk' (
$strkk( 0
]kk0 1
,kk1 2
spNamekk3 9
=kk: ;
nvckk< ?
[kk? @
$strkk@ H
]kkH I
,kkI J
	iterationkkK T
=kkU V
nvckkW Z
[kkZ [
$strkk[ f
]kkf g
;kkg h
ifmm 
(mm 
!mm 
stringmm 
.mm  
IsNullOrEmptymm  -
(mm- .
dBNamemm. 4
)mm4 5
&&mm6 8
!mm9 :
stringmm: @
.mm@ A
IsNullOrEmptymmA N
(mmN O
spNamemmO U
)mmU V
)mmV W
{nn 
ifoo 
(oo 
	iterationoo %
==oo& (
_retryCountoo) 4
)oo4 5
{pp 
_modelqq "
.qq" #
BasicRejectqq# .
(qq. /
deliverEventArgsqq/ ?
.qq? @
DeliveryTagqq@ K
,qqK L
falseqqM R
)qqR S
;qqS T
Logsrr  
.rr  !
WriteInfoLogrr! -
(rr- .
$strrr. [
+rr\ ]
	iterationrr^ g
)rrg h
;rrh i
}ss 
elsett 
iftt 
(tt  !
nvctt! $
.tt$ %
Counttt% *
>=tt+ -
Converttt. 5
.tt5 6
ToInt32tt6 =
(tt= >
_retryCounttt> I
)ttI J
)ttJ K
{uu 
StringBuildervv )
stringBuildervv* 7
=vv8 9
newvv: =
StringBuildervv> K
(vvK L
$strvvL [
)vv[ \
;vv\ ]
DynamicParametersww -
dynamicParameters1ww. @
=wwA B
newwwC F
DynamicParameterswwG X
(wwX Y
)wwY Z
;wwZ [
foreachyy #
(yy$ %
stringyy% +
indexyy, 1
inyy2 4
nvcyy5 8
.yy8 9
Keysyy9 =
)yy= >
{zz 
stringBuilder{{  -
.{{- .
Append{{. 4
({{4 5
index{{5 :
+{{; <
$str{{= C
+{{D E
nvc{{F I
[{{I J
index{{J O
]{{O P
+{{Q R
$str{{S W
){{W X
;{{X Y
dynamicParameters1||  2
.||2 3
Add||3 6
(||6 7
index||7 <
,||< =
(||> ?
object||? E
)||E F
nvc||F I
[||I J
index||J O
]||O P
,||P Q
new||R U
DbType||V \
?||\ ]
(||] ^
)||^ _
,||_ `
new||a d
ParameterDirection||e w
?||w x
(||x y
)||y z
,||z {
new||| 
int
||Ä É
?
||É Ñ
(
||Ñ Ö
)
||Ö Ü
,
||Ü á
new
||à ã
byte
||å ê
?
||ê ë
(
||ë í
)
||í ì
,
||ì î
new
||ï ò
byte
||ô ù
?
||ù û
(
||û ü
)
||ü †
)
||† °
;
||° ¢
}}} 
Logs  
.  !
WriteInfoLog! -
(- .
stringBuilder. ;
.; <
ToString< D
(D E
)E F
)F G
;G H
using
ÅÅ !
(
ÅÅ" #
IDbConnection
ÅÅ# 0
dbConnection1
ÅÅ1 >
=
ÅÅ? @
(
ÅÅA B
IDbConnection
ÅÅB O
)
ÅÅO P
this
ÅÅP T
.
ÅÅT U
GetDBConnection
ÅÅU d
(
ÅÅd e
dBName
ÅÅe k
)
ÅÅk l
)
ÅÅl m
{
ÇÇ 
try
ÉÉ  #
{
ÑÑ  !
	SqlMapper
ÖÖ$ -
.
ÖÖ- .
Execute
ÖÖ. 5
(
ÖÖ5 6
dbConnection1
ÖÖ6 C
,
ÖÖC D
spName
ÖÖE K
,
ÖÖK L
(
ÖÖM N
object
ÖÖN T
)
ÖÖT U 
dynamicParameters1
ÖÖU g
,
ÖÖg h
(
ÖÖi j
IDbTransaction
ÖÖj x
)
ÖÖx y
null
ÖÖy }
,
ÖÖ} ~
newÖÖ Ç
intÖÖÉ Ü
?ÖÖÜ á
(ÖÖá à
)ÖÖà â
,ÖÖâ ä
newÖÖã é
CommandTypeÖÖè ö
?ÖÖö õ
(ÖÖõ ú
CommandTypeÖÖú ß
.ÖÖß ®
StoredProcedureÖÖ® ∑
)ÖÖ∑ ∏
)ÖÖ∏ π
;ÖÖπ ∫
_model
áá$ *
.
áá* +
BasicAck
áá+ 3
(
áá3 4
deliverEventArgs
áá4 D
.
ááD E
DeliveryTag
ááE P
,
ááP Q
false
ááR W
)
ááW X
;
ááX Y
Logs
àà$ (
.
àà( )
WriteInfoLog
àà) 5
(
àà5 6
string
àà6 <
.
àà< =
Format
àà= C
(
ààC D
$strààD §
,àà§ •
dBNameàà¶ ¨
,àà¨ ≠
spNameàà≠ ≥
)àà≥ ¥
)àà¥ µ
;ààµ ∂
}
ââ  !
catch
ää  %
(
ää& '
	Exception
ää' 0
ex
ää1 3
)
ää3 4
{
ãã  !
Logs
åå$ (
.
åå( )
WriteInfoLog
åå) 5
(
åå5 6
string
åå6 <
.
åå< =
Format
åå= C
(
ååC D
$strååD £
,åå£ §
dBNameåå• ´
,åå´ ¨
spNameåå≠ ≥
)åå≥ ¥
)åå¥ µ
;ååµ ∂
this
çç$ (
.
çç( )
DeadLetterPublish
çç) :
(
çç: ;
nvc
çç; >
,
çç> ?

_queueName
çç@ J
)
ççJ K
;
ççK L
_model
èè$ *
.
èè* +
BasicReject
èè+ 6
(
èè6 7
deliverEventArgs
èè7 G
.
èèG H
DeliveryTag
èèH S
,
èèS T
false
èèU Z
)
èèZ [
;
èè[ \
Logs
ëë$ (
.
ëë( )
WriteErrorLog
ëë) 6
(
ëë6 7
$str
ëë7 \
+
ëë] ^
ex
ëë_ a
.
ëëa b
Message
ëëb i
)
ëëi j
;
ëëj k
SendMail
íí$ ,
.
íí, -
HandleException
íí- <
(
íí< =
ex
íí= ?
,
íí? @
$str
ííA f
+
ííg h
ex
ííi k
.
íík l
Message
ííl s
)
íís t
;
íít u
}
ìì  !
}
îî 
}
ïï 
else
ññ 
{
óó 
_model
òò "
.
òò" #
BasicReject
òò# .
(
òò. /
deliverEventArgs
òò/ ?
.
òò? @
DeliveryTag
òò@ K
,
òòK L
false
òòM R
)
òòR S
;
òòS T
}
ôô 
}
öö 
else
õõ 
{
úú 
_model
ùù 
.
ùù 
BasicReject
ùù *
(
ùù* +
deliverEventArgs
ùù+ ;
.
ùù; <
DeliveryTag
ùù< G
,
ùùG H
false
ùùI N
)
ùùN O
;
ùùO P
Logs
ûû 
.
ûû 
WriteErrorLog
ûû *
(
ûû* +
$str
ûû+ F
)
ûûF G
;
ûûG H
SendMail
üü  
.
üü  !
HandleException
üü! 0
(
üü0 1
new
üü1 4
	Exception
üü5 >
(
üü> ?
$str
üü? c
)
üüc d
,
üüd e
String
üüf l
.
üül m
Format
üüm s
(
üüs t
$strüüt ∫
,üü∫ ª
dBNameüüª ¡
,üü¡ ¬
spNameüü¬ »
)üü» …
)üü…  
;üü  À
}
†† 
}
°° 
catch
¢¢ 
(
¢¢ 
	Exception
¢¢  
ex
¢¢! #
)
¢¢# $
{
££ 
Logs
§§ 
.
§§ 
WriteErrorLog
§§ &
(
§§& '
$str
§§' Q
+
§§R S
ex
§§T V
.
§§V W
Message
§§W ^
)
§§^ _
;
§§_ `
SendMail
•• 
.
•• 
HandleException
•• ,
(
••, -
ex
••- /
,
••/ 0
$str
••1 i
)
••i j
;
••j k
}
¶¶ 
}
ßß 
}
®® 	
private
∞∞ 
DbConnection
∞∞ 
GetDBConnection
∞∞ ,
(
∞∞, -
string
∞∞- 3
Database
∞∞4 <
)
∞∞< =
{
±± 	
switch
≤≤ 
(
≤≤ 
Database
≤≤ 
)
≤≤ 
{
≥≥ 
case
¥¥ 
$str
¥¥ 
:
¥¥ 
if
µµ 
(
µµ 
!
µµ 
string
µµ 
.
µµ  
IsNullOrEmpty
µµ  -
(
µµ- .!
_BWConnectionString
µµ. A
)
µµA B
)
µµB C
return
∂∂ 
(
∂∂  
DbConnection
∂∂  ,
)
∂∂, -
new
∂∂- 0
MySqlConnection
∂∂1 @
(
∂∂@ A!
_BWConnectionString
∂∂A T
)
∂∂T U
;
∂∂U V
break
∑∑ 
;
∑∑ 
case
∏∏ 
$str
∏∏ 
:
∏∏ 
case
ππ 
$str
ππ 
:
ππ 
if
∫∫ 
(
∫∫ 
!
∫∫ 
string
∫∫ 
.
∫∫  
IsNullOrEmpty
∫∫  -
(
∫∫- .!
_CWConnectionString
∫∫. A
)
∫∫A B
)
∫∫B C
return
ªª 
(
ªª  
DbConnection
ªª  ,
)
ªª, -
new
ªª- 0
MySqlConnection
ªª1 @
(
ªª@ A!
_CWConnectionString
ªªA T
)
ªªT U
;
ªªU V
break
ºº 
;
ºº 
}
ΩΩ 
return
øø 
(
øø 
DbConnection
øø  
)
øø  !
new
øø! $
SqlConnection
øø% 2
(
øø2 3
)
øø3 4
;
øø4 5
}
¿¿ 	
private
¬¬ !
NameValueCollection
¬¬ #
ByteArrayToObject
¬¬$ 5
(
¬¬5 6
byte
¬¬6 :
[
¬¬: ;
]
¬¬; <
	byteArray
¬¬= F
)
¬¬F G
{
√√ 	
MemoryStream
ƒƒ 
memoryStream
ƒƒ %
=
ƒƒ& '
new
ƒƒ( +
MemoryStream
ƒƒ, 8
(
ƒƒ8 9
	byteArray
ƒƒ9 B
)
ƒƒB C
;
ƒƒC D
BinaryFormatter
≈≈ 
binaryFormatter
≈≈ +
=
≈≈, -
new
≈≈. 1
BinaryFormatter
≈≈2 A
(
≈≈A B
)
≈≈B C
;
≈≈C D
binaryFormatter
∆∆ 
.
∆∆ 
AssemblyFormat
∆∆ *
=
∆∆+ ,$
FormatterAssemblyStyle
∆∆- C
.
∆∆C D
Simple
∆∆D J
;
∆∆J K
memoryStream
«« 
.
«« 
Position
«« !
=
««" #
$num
««$ &
;
««& '
return
»» 
(
»» !
NameValueCollection
»» '
)
»»' (
binaryFormatter
»»( 7
.
»»7 8
Deserialize
»»8 C
(
»»C D
(
»»D E
Stream
»»E K
)
»»K L
memoryStream
»»L X
)
»»X Y
;
»»Y Z
}
…… 	
private
ÀÀ 
void
ÀÀ 
DeadLetterPublish
ÀÀ &
(
ÀÀ& '!
NameValueCollection
ÀÀ' :
nvc
ÀÀ; >
,
ÀÀ> ?
string
ÀÀ@ F
	queueName
ÀÀG P
)
ÀÀP Q
{
ÃÃ 	
RabbitMqPublish
ÕÕ 
rabbitMqPublish
ÕÕ +
=
ÕÕ, -
new
ÕÕ. 1
RabbitMqPublish
ÕÕ2 A
(
ÕÕA B
)
ÕÕB C
;
ÕÕC D
rabbitMqPublish
ŒŒ 
.
ŒŒ #
UseDeadLetterExchange
ŒŒ 1
=
ŒŒ2 3
true
ŒŒ3 7
;
ŒŒ7 8
rabbitMqPublish
œœ 
.
œœ 

MessageTTL
œœ &
=
œœ' (
int
œœ) ,
.
œœ, -
Parse
œœ- 2
(
œœ2 3
_RabbitMsgTTL
œœ3 @
)
œœ@ A
;
œœA B
int
–– 
num
–– 
=
–– 
nvc
–– 
[
–– 
$str
–– %
]
––% &
==
––' )
null
––* .
?
––/ 0
$num
––1 2
:
––3 4
(
––5 6
int
––6 9
)
––9 :
short
––: ?
.
––? @
Parse
––@ E
(
––E F
nvc
––F I
[
––I J
$str
––J U
]
––U V
)
––V W
+
––X Y
$num
––Z [
;
––[ \
nvc
—— 
.
—— 
Set
—— 
(
—— 
$str
—— 
,
——  
num
——! $
.
——$ %
ToString
——% -
(
——- .
)
——. /
)
——/ 0
;
——0 1
rabbitMqPublish
““ 
.
““ 
PublishToQueue
““ *
(
““* +
	queueName
““+ 4
,
““4 5
nvc
““6 9
)
““9 :
;
““: ;
}
”” 	
private
’’ 
void
’’ (
consumer_ConsumerCancelled
’’ /
(
’’/ 0
object
’’0 6
sender
’’7 =
,
’’= >
RabbitMQ
’’? G
.
’’G H
Client
’’H N
.
’’N O
Events
’’O U
.
’’U V
ConsumerEventArgs
’’V g
args
’’h l
)
’’l m
{
÷÷ 	
Logs
◊◊ 
.
◊◊ 
WriteInfoLog
◊◊ 
(
◊◊ 
$str
◊◊ ?
)
◊◊? @
;
◊◊@ A
CreateConnection
ÿÿ 
.
ÿÿ 
CloseConnections
ÿÿ -
(
ÿÿ- .
)
ÿÿ. /
;
ÿÿ/ 0
CreateConnection
ŸŸ 
.
ŸŸ 
RefreshNodes
ŸŸ )
(
ŸŸ) *
)
ŸŸ* +
;
ŸŸ+ ,
CreateConnection
⁄⁄ 
.
⁄⁄ 
GetNextNode
⁄⁄ (
(
⁄⁄( )
)
⁄⁄) *
;
⁄⁄* +

_queueName
€€ 
=
€€ 
CreateConnection
€€ )
.
€€) *
	QueueName
€€* 3
;
€€3 4
	_hostName
‹‹ 
=
‹‹ 
CreateConnection
‹‹ (
.
‹‹( )
serverIp
‹‹) 1
;
‹‹1 2
InitConsumer
›› 
(
›› 
)
›› 
;
›› 
ProcessQueries
ﬁﬁ 
(
ﬁﬁ 
)
ﬁﬁ 
;
ﬁﬁ 
}
ﬂﬂ 	
}
‡‡ 
}·· ¸
9D:\work\bikewaleweb\Bikewale.DataSync\DataSync\Program.cs
	namespace 	
DataSync
 
{ 
internal		 
class		 
Program		 
{

 
static 
void 
Main 
( 
string 
[  
]  !
args" &
)& '
{ 	
log4net 
. 
Config 
. 
XmlConfigurator *
.* +
	Configure+ 4
(4 5
)5 6
;6 7
try 
{ 
Logs 
. 
WriteInfoLog !
(! "
$str" 1
+2 3
DateTime4 <
.< =
Now= @
)@ A
;A B
DataSyncConsumer  
dataSyncConsumer! 1
=2 3
new4 7
DataSyncConsumer8 H
(H I
)I J
;J K
dataSyncConsumer  
.  !
ProcessQueries! /
(/ 0
)0 1
;1 2
} 
catch 
( 
	Exception 
ex 
)  
{ 
Logs 
. 
WriteErrorLog "
(" #
$str# 1
+2 3
ex4 6
.6 7
Message7 >
)> ?
;? @
} 
finally 
{ 
Logs 
. 
WriteInfoLog !
(! "
$str" -
+. /
DateTime0 8
.8 9
Now9 <
)< =
;= >
} 
} 	
} 
} Ù
ID:\work\bikewaleweb\Bikewale.DataSync\DataSync\Properties\AssemblyInfo.cs
[ 
assembly 	
:	 

AssemblyTitle 
( 
$str #
)# $
]$ %
[		 
assembly		 	
:			 

AssemblyDescription		 
(		 
$str		 !
)		! "
]		" #
[

 
assembly

 	
:

	 
!
AssemblyConfiguration

  
(

  !
$str

! #
)

# $
]

$ %
[ 
assembly 	
:	 

AssemblyCompany 
( 
$str 
) 
] 
[ 
assembly 	
:	 

AssemblyProduct 
( 
$str %
)% &
]& '
[ 
assembly 	
:	 

AssemblyCopyright 
( 
$str 0
)0 1
]1 2
[ 
assembly 	
:	 

AssemblyTrademark 
( 
$str 
)  
]  !
[ 
assembly 	
:	 

AssemblyCulture 
( 
$str 
) 
] 
[ 
assembly 	
:	 


ComVisible 
( 
false 
) 
] 
[ 
assembly 	
:	 

Guid 
( 
$str 6
)6 7
]7 8
[## 
assembly## 	
:##	 

AssemblyVersion## 
(## 
$str## $
)##$ %
]##% &
[$$ 
assembly$$ 	
:$$	 

AssemblyFileVersion$$ 
($$ 
$str$$ (
)$$( )
]$$) *