<div id="priceInCityPopUp" class="hide popup-loader-animate">
    <div class="bw-popup bw-popup-sm" data-bind="css: IsLoading() ? 'location-loader-active' : ''">
        <!-- ko if : IsLoading() -->
        <div class="content-inner-block-20">
            <div class="location-loader-container">
                <div class="loader-flipper">
                    <div class="loader-front">
                        <span class="bwsprite red-marker"></span>
                    </div>
                    <div class="loader-back">
                        <span class="bwsprite black-marker"></span>
                    </div>
                </div>
            </div>
            <p data-bind="text : LoadingText()" class="font14 text-center"></p>
        </div>
        <!-- /ko -->
        <!-- ko ifnot : IsLoading() -->
        <div class="popup-inner-container">
            <div class="bwsprite popup-close-btn close-btn position-abt pos-top10 pos-right10 cur-pointer"></div>
            <div class="cityPop-icon-container">
                <div class="icon-outer-container rounded-corner50 margin-bottom20">
                    <div class="icon-inner-container rounded-corner50">
                        <span class="bwsprite orp-location-icon margin-top20"></span>
                    </div>
                </div>
            </div>
            <p class="font20 margin-top15 text-capitalize text-center">Please Tell Us Your Location</p>
            <p class="text-light-grey margin-bottom15 margin-top15 text-capitalize text-center">See on-road prices in your city!</p>

            <div class="padding-top10" id="priceInCityPopUpContent">
                <div class="select-box margin-top10">
                    <select class="chosen-select" data-placeholder="Select city" id="priceinCityPopupList" tabindex="2"
                            data-bind="options: ListCities(),value: SelectedCityId, optionsCaption:'--Select City--', optionsText: 'cityName', optionsValue: 'cityId',chosen: { width: '100%',search_contains: true },event : { change : removeErr }"></select>
                    <span class="boundary"></span>
                    <span class="error-text" data-bind="text: errMsg"></span>
                    <p class="position-abt progress-bar"></p>
                    <p class="position-abt progress-bar-label"></p>
                </div>
                <input id="btnPriceInCity" class="action-btn margin-top15 margin-left60 " style="display: block;" type="button" value="Show on-road price" data-bind="click: goToPriceInCity">
                 </div>

        </div>
        <!-- /ko -->
    </div>
</div>

<script type="text/javascript">
    var vmPriceInCity, timeOutVariable, pcPopupContent, progressBar;
    var CitiesKey,isAborted = false;
    docReady(function () {
        bwcache.removeAll(true);
        
        $(document).on("click", ".blackOut-window, #priceInCityPopUp .close-btn", function () {
            pcPopupContent.close();
        });

        var chosenSelectBox = $('.chosen-select');

        chosenSelectBox.each(function () {
            var text = $(this).attr('data-placeholder');
            $(this).siblings('.chosen-container').find('input[type=text]').attr('placeholder', text);
        });


        $(document).keydown(function (event) {
            if (event.keyCode == 27) {
                if ($('#priceInCityPopUp').is(':visible')) {
                    pcPopupContent.close();
                }
            }
        });      
       
        CitiesKey = "PriceInCityPopUp_";
       
        bwcache.setScope('PriceInCityPopUp');
     
        $(".changepriceincitypage").click(function (e) {
            var ele = $(this); e.stopPropagation(); e.preventDefault();
            $('#priceInCityPopUp,#priceInCityPopUpContent,.blackOut-window').show();
            vmPriceInCity.IsLoading(true);
            
            var options = {
                "modelId": ele.attr('data-modelid'),
                "makemasking": ele.attr('data-makemasking'),
                "modelmasking": ele.attr('data-modelmasking'),
              };            
             vmPriceInCity.setOptions(options);
             vmPriceInCity.LoadCities();
             });
       
        var pcPopup = function () {
            var self = this;
            self.MakeMasking = "";
            self.ModelMasking = "";
            self.SelectedModelId = ko.observable();
            self.SelectedCity = ko.observable();
            self.SelectedCityMasking = ko.observable();
            self.SelectedCityId = ko.observable();
            self.ListCities = ko.observableArray([]);
            self.IsReload = ko.observable(false);
            self.cityFilter = ko.observable("");
            self.LoadingText = ko.observable("Loading cities...");
            self.validate = ko.observable(false);
            self.IsLoading = ko.observable(false);
            self.errMsg = ko.observable();
                  self.setOptions = function (options, event) {
                    if (options != null) {
                        self.IsLoading(true);
                        self.SelectedModelId(options.modelId || 0);
                        self.MakeMasking = options.makemasking || "";
                        self.ModelMasking = options.modelmasking || "";
                        self.pqCityApiUrl = "/api/pqcitylist/?modelId=" + self.SelectedModelId();
                    }
                  };
                  self.removeErr = function () {
                      self.errMsg("");
                  };
                  self.LoadCities = function () {
                      try {
                          CitiesKey = "PriceInCityPopUp_" + self.SelectedModelId();
                          self.IsLoading(true);
                          pcPopupContent.updateChosen('#priceinCityPopupList');
                          $.ajax({
                              type: "GET",
                              url: self.pqCityApiUrl,
                              dataType: 'json',
                              beforeSend: function (xhr) {

                                  progressBar.startLoading();
                                  if (data = bwcache.get(CitiesKey)) {
                                      var cities = ko.toJS(data.cities);
                                      if (cities) {
                                          progressBar.stopLoading();
                                          self.ListCities(cities);
                                          isAborted = true;
                                          xhr.abort();
                                      }
                                      else {
                                          self.ListCities([]);
                                      }
                                  }
                              },
                              success: function (response) {
                                  var cities = ko.toJS(response.cities);
                                  if (cities) {
                                      bwcache.set(CitiesKey, cities, 60);
                                      progressBar.stopLoading();
                                      self.ListCities(cities);
                                      self.IsLoading(false);
                                      pcPopupContent.active();
                                      pcPopupContent.updateChosen($('#priceinCityPopupList'));

                                  }
                                  else {
                                      self.ListCities([]);
                                      pcPopupContent.updateChosen($('#priceinCityPopupList'));
                                  }
                              },
                              complete: function () {
                                  if (self.SelectedCityId() > 0) {
                                      $('#priceinCityPopupList').parent().addClass('done');

                                  }
                                  pcPopupContent.updateChosen($('#priceinCityPopupList'));
                              }
                          });

                          if (isAborted) {
                              pcPopupContent.updateChosen($('#priceinCityPopupList'));
                          }
                      }
                      catch (e) {
                          console.warn(e);
                      }

                  };

                self.redirectToPriceInCity = function () {
                    try {
                        if (self.SelectedCity() != null && self.SelectedModelId() > 0) {
                            window.location = "/" + self.MakeMasking + "-bikes/" + self.ModelMasking + "/price-in-" + self.SelectedCityMasking() + "/";
                        }
                    }
                    catch (e) {
                        console.warn(e);
                    }
                };
                self.goToPriceInCity = function () {
                    if (self.SelectedCityId() != undefined && self.SelectedCityId() > 0) {
                       self.selectCity();
                    }
                    else
                        self.errMsg("Please select city.");
                };

                self.selectCity = function () {
                    try {
                        self.SelectedCity(self.findById(self.ListCities(), "cityId", self.SelectedCityId()));
                        self.SelectedCityMasking(self.SelectedCity().maskingName);
                        if (self.SelectedCity() != null && self.SelectedCity().cityId > 0) {
                           $('#priceinCityPopupList').parent().addClass('done');

                            self.LoadingText("Fetching on-road price for " + self.SelectedCity().cityName);
                            self.IsLoading(true);
                            self.redirectToPriceInCity();
                           
                        }
                    } catch (e) {
                        console.warn(e);
                    }

                };

                self.findById = function (items, attr, item) {
                    return ko.utils.arrayFirst(items, function (child) {
                        return (child[attr] == item);
                    });
                };
            };
       
            
            pcPopupContent = {
                
                active: function () {
                    timeOutVariable = setTimeout(function () {
                        $('#priceInCityPopUp').addClass('activate-popup-content');
                    }, 200);
                },

                inactive: function () {
                    $('#priceInCityPopUp').removeClass('activate-popup-content');
                    clearTimeout(timeOutVariable);
                },

                updateChosen: function (element) {
                    $(element).trigger("chosen:updated");
                },

                close: function () {
                    $('.changepriceincitypage').removeClass('ui-btn-active');
                    $("#priceInCityPopUp,#priceInCityPopUpContent,.blackOut-window").hide();
                    pcPopupContent.inactive();
                }
            };


            progressBar = {
                startLoading: function (element, message) {
                    try {
                        var _self = $(element).find(".progress-bar").css({ 'width': '0' }).show();
                        _self.animate({ width: '100%' }, 7000);
                        $(element).find(".progress-bar-label").text(message);
                    }
                    catch (e) { return };
                },

                stopLoading: function (element) {
                    try {
                        var _self = $(element).find(".progress-bar");
                        _self.stop(true, true).css({ 'width': '100%' }).fadeOut(1000);
                        $(element).find(".progress-bar-label").empty();
                    }
                    catch (e) { return };
                }
            };

            vmPriceInCity = new pcPopup;
            ko.applyBindings(vmPriceInCity, $("#priceInCityPopUp")[0]);
            $('#priceinCityPopupList').chosen();

        });
   
</script>