@model Bikewale.Entities.PriceQuote.v2.DetailedDealerQuotationEntity

@if (Model != null && Model.PrimaryDealer != null && Model.PrimaryDealer.DealerDetails != null && Model.PrimaryDealer.DealerDetails.objArea != null)
{
    var PrimaryDealerDetails = Model.PrimaryDealer.DealerDetails;

    <div class="inner-card-shadow margin-top20">
        <div class="content-inner-block-20 position-rel">
            <div id="pq-dealer-name" class="inline-block">
                <div class="inline-block margin-right10">
                    <span class="pq-sprite partner-dealer"></span>
                </div>
                <div class="inline-block dealer-name-content">
                    <h3 class="font18 text-black margin-bottom5 inline-block">@PrimaryDealerDetails.Organization</h3>
                    @if (!string.IsNullOrEmpty(PrimaryDealerDetails.MaskingNumber))
                    {
                        <div class="margin-left10 inline-block">
                            <span class="bwsprite phone-black-icon vertical-top"></span>
                            <span class="font15 vertical-top text-bold ">@PrimaryDealerDetails.MaskingNumber</span>
                        </div>
                    }
                    <p class="font12 text-light-grey">@(!PrimaryDealerDetails.IsDSA ? "Authorized Dealer in " : "Multi-brand Dealer in ")@PrimaryDealerDetails.objArea.AreaName</p>
                </div>
            </div>
            <div id="dealer-offers-label" class="inline-block">
                <p class="font14">Get in touch with this dealer for:</p>
                <ul id="offers-label-list">
                    <li>Best offers</li>
                    <li>Test rides</li>
                    <li>EMI options</li>
                </ul>
            </div>
            <div id="get-offers-btn-content" class="inline-block @(PrimaryDealerDetails.IsDSA ? " rightfloat " :"" )">
                <a href=" javascript:void(0)" id="leadBtn" data-leadsourceid="9" data-item-id="@PrimaryDealerDetails.DealerId" data-item-name="@PrimaryDealerDetails.Organization" data-item-area="@PrimaryDealerDetails.objArea.AreaName" class="btn btn-orange pq-get-dealer-offers leadcapturebtn" c="DealerPriceQoute_Page" a="Get_Offers_Clicked" v="bikeVerLocation" rel="nofollow">
                    @PrimaryDealerDetails.DisplayTextLarge
                </a>
            </div>
            <div class="clear"></div>
            @if (PrimaryDealerDetails.IsDSA)
            {
                <div class="bw-tooltip pq-multi-brand-tooltip tooltip-bottom slideUp-tooltip">
                    <p class="bw-tooltip-text position-rel font14">This dealer sells bikes of multiple brands. Above price is not final and may vary at the dealership.</p>
                    <span class="position-abt pos-top15 pos-right15 bwsprite cross-sm-dark-grey cur-pointer close-bw-tooltip"></span>
                </div>
            }
            <div class="margin-top20 border-solid-bottom"></div>
        </div>
        <div id="dealer-contact-details" class="padding-right20 padding-bottom20 padding-left20 @(Model.PrimaryDealer.IsPremiumDealer ? " " : " map-absent") ">
            <!-- if no map, add 'map-absent' class -->
            <div class="alpha font14 @(Model.PrimaryDealer.IsPremiumDealer ? " grid-6" : "grid-12 omega")">
                <!-- if no map, replace grid-6 with grid-12 -->
                @if (!string.IsNullOrEmpty(PrimaryDealerDetails.Address))
                {
                    <p class=" text-bold margin-bottom15">Dealer contact details</p>
                    <div class="margin-bottom10">
                        <span class="bwsprite dealership-loc-icon vertical-top margin-right5"></span>
                        <span class="vertical-top text-light-grey details-column">@PrimaryDealerDetails.Address</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(PrimaryDealerDetails.MaskingNumber))
                {
                    <div class="dealer-details-item">
                        <span class="bwsprite phone-black-icon vertical-top"></span>
                        <span class="font15 vertical-top text-bold details-column">@PrimaryDealerDetails.MaskingNumber</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(PrimaryDealerDetails.EmailId))
                {
                    <div class="dealer-details-item">
                        <span class="bwsprite mail-grey-icon vertical-top"></span>
                        <a href="mailto:@PrimaryDealerDetails.EmailId" target="_blank" class="vertical-top text-light-grey" rel="nofollow">
                            <span class="dealership-card-details">@PrimaryDealerDetails.EmailId</span>
                        </a>
                    </div>
                }
                @if (!string.IsNullOrEmpty(PrimaryDealerDetails.WorkingTime))
                {
                    <div class="dealer-details-item">
                        <span class="bwsprite clock-icon vertical-top"></span>
                        <span class="vertical-top text-light-grey details-column">Working hours: @PrimaryDealerDetails.WorkingTime</span>
                    </div>
                }
            </div>
            @if (Model.PrimaryDealer.IsPremiumDealer)
            {
                <div class="grid-6 omega">
                    <script src="https://maps.googleapis.com/maps/api/js?key=@Bikewale.Utility.BWConfiguration.Instance.GoogleMapApiKey&callback=initializeDealerMap" async defer></script>

                    <div id="dealerMap" style="width: 438px; height: 202px; border: 1px solid #f5f5f5;"></div>
                    <div id="get-direction-button" title="get directions">
                        <a href="https://maps.google.com/?saddr=&daddr=@PrimaryDealerDetails.objArea.Latitude,@PrimaryDealerDetails.objArea.Longitude" target="_blank">
                            <span class="bwsprite get-direction-icon"></span>
                        </a>
                    </div>
                    <script type="text/javascript">
                        function initializeDealerMap() {
                            var element = document.getElementById('dealerMap');
                            var latitude = '@PrimaryDealerDetails.objArea.Latitude';
                            var longitude = '@PrimaryDealerDetails.objArea.Longitude';

                            try {
                                mapUrl = "https://maps.google.com/?q=" + latitude + "," + longitude;
                                latLng = new google.maps.LatLng(latitude, longitude),
                                mapOptions = {
                                    zoom: 13,
                                    center: latLng,
                                    scrollwheel: false,
                                    navigationControl: false,
                                    draggable: false,
                                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                                    disableDefaultUI: true
                                },
                                map = new google.maps.Map(element, mapOptions),
                                marker = new google.maps.Marker({
                                    title: "Dealer's Location",
                                    position: latLng,
                                    map: map,
                                    animation: google.maps.Animation.DROP
                                });

                                google.maps.event.addListener(marker, 'click', function () {
                                    window.open(mapUrl, '_blank');
                                });

                                google.maps.event.addListener(map, 'click', function () {
                                    window.open(mapUrl, '_blank');
                                });

                                google.maps.event.addListenerOnce(map, 'idle', function () {
                                });
                            } catch (e) {
                                return;
                            }
                        }
                    </script>
                </div>
            }
            <div class="clear"></div>
        </div>

        @if (Model.PrimaryDealer.EMIDetails != null && !Model.PrimaryDealer.IsStandardDealer)
        {
            <!-- EMI calculator starts -->
            <div class="margin-right20 margin-left20 border-solid-bottom"></div>
            <div class="content-inner-block-20">
                <p class="font14 text-bold margin-bottom15">EMI calculator</p>
                <div id="EMISection" data-bind="visible: true" style="display: none" class="font14">
                    <div class="grid-8 alpha border-light-right padding-bottom5 margin-bottom10">
                        <div class="emi-slider-box">
                            <p class="text-light-grey leftfloat">Down payment</p>
                            <p class="rightfloat margin-right15"><span class="bwsprite inr-sm"></span>&nbsp;<span id="downPaymentAmount" class="text-bold" data-bind="text: formatPrice(Math.round(downPayment()))"></span></p>
                            <div class="clear"></div>

                            <div id="downPaymentSlider"
                                 data-bind="slider: downPayment, sliderOptions: { min: minDnPay(), max: maxDnPay(), range: 'min', step: 1, value: Math.round(((maxDnPay() - minDnPay()) / 2 ) + minDnPay()) }"
                                 class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
                                <div class="ui-slider-range ui-widget-header ui-corner-all ui-slider-range-min"></div>
                                <span class="ui-slider-handle ui-state-default ui-corner-all" tabindex="0"></span>
                            </div>
                        </div>

                        <div class="emi-slider-box">
                            <p class="text-light-grey leftfloat">Loan Amount</p>
                            <p class="rightfloat margin-right15"><span class="bwsprite inr-sm"></span>&nbsp;<span id="loanAmount" class="text-bold" data-bind="text: formatPrice(Math.round(loan()))"></span></p>
                            <div class="clear"></div>

                            <div id="loanAmountSlider"
                                 data-bind="slider: loan, sliderOptions: { min: bikePrice() - maxDnPay(), max: bikePrice() - minDnPay(), range: 'min', step: 1 }"
                                 class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
                                <div class="ui-slider-range ui-widget-header ui-corner-all ui-slider-range-min"></div>
                                <span class="ui-slider-handle ui-state-default ui-corner-all" tabindex="0"></span>
                            </div>
                        </div>

                        <div class="emi-slider-box">
                            <p class="text-light-grey leftfloat">Tenure (Months)</p>
                            <p class="rightfloat text-bold margin-right15"><span id="tenurePeriod" data-bind="text: tenure"></span>&nbsp;Months</p>
                            <div class="clear"></div>

                            <div id="tenureSlider"
                                 data-bind="slider: tenure, sliderOptions: { min: minTenure(), max: maxTenure(), range: 'min', step: 1 }"
                                 class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
                                <div class="ui-slider-range ui-widget-header ui-corner-all ui-slider-range-min"></div>
                                <span class="ui-slider-handle ui-state-default ui-corner-all" tabindex="0"></span>
                            </div>
                        </div>

                        <div class="emi-slider-box">
                            <p class="text-light-grey leftfloat">Rate of interest (Percentage)</p>
                            <p class="rightfloat text-bold margin-right15"><span id="rateOfInterestPercentage" class="text-bold" data-bind="text: rateofinterest">5</span>%</p>
                            <div class="clear"></div>

                            <div id="rateOfInterestSlider"
                                 data-bind="slider: rateofinterest, sliderOptions: { min: minROI(), max: maxROI(), range: 'min', step: 0.25 }"
                                 class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
                                <div class="ui-slider-range ui-widget-header ui-corner-all ui-slider-range-min"></div>
                                <span class="ui-slider-handle ui-state-default ui-corner-all" tabindex="0"></span>
                            </div>
                        </div>
                    </div>
                    <div class="grid-4 padding-left20 omega">
                        <div class="margin-left10 margin-bottom15">
                            <p class="font14 text-light-grey margin-bottom5">Total amount (Principal + Interest)</p>
                            <div>
                                <span class="bwsprite inr-md"></span>
                                <span class="font16 text-bold" data-bind="text: formatPrice(Math.round(totalPayable()))"></span>
                            </div>
                        </div>
                        <div class="border-light-bottom margin-bottom15"></div>
                        <div class="margin-left10">
                            <p class="font14 text-light-grey margin-bottom5">Indicative EMI</p>
                            <div class="margin-bottom15">
                                <span class="bwsprite inr-lg"></span>
                                <span class="font18 text-bold">
                                    <span id="emiAmount" data-bind="text: formatPrice(monthlyEMI())"></span> per month
                                </span>
                            </div>
                            <a id="btnEmiQuote" data-leadsourceid="11" data-item-name="@PrimaryDealerDetails.Organization" data-item-area="@PrimaryDealerDetails.objArea.AreaName" data-item-id="@PrimaryDealerDetails.DealerId" class="btn btn-grey btn-md font14 leadcapturebtn">Get EMI quote</a>
                        </div>

                    </div>
                    <div class="clear"></div>
                </div>
                <div class="clear"></div>
            </div>
            <!-- EMI calculator ends -->
        }

        @if ((!Model.PrimaryDealer.IsStandardDealer && Model.PrimaryDealer.HasOffers) || (Model.PrimaryDealer.IsPremiumDealer && Model.PrimaryDealer.HasBenefits))
        {
            <!-- offers and benefits starts here -->
            <div class="margin-right20 margin-left20 border-solid-bottom"></div>
            <div class="content-inner-block-20 font14">
                @if (!Model.PrimaryDealer.IsStandardDealer && Model.PrimaryDealer.HasOffers)
                {
                    bool isSingleOffer = Model.PrimaryDealer.OfferList.Count() == 1;
                    <!-- offers -->
                    <div class="alpha @(Model.PrimaryDealer.IsPremiumDealer && Model.PrimaryDealer.HasBenefits ? " grid-6 border-light-right"  :"grid-12 omega offers-or-benefits")">
                        <p class=" text-bold margin-bottom5">
                            Offers from this dealer:
                        </p>
                        <ul class="dealership-benefit-list">

                            @foreach (var offer in Model.PrimaryDealer.OfferList)
                            {

                                <li class="@( isSingleOffer ? " single-offer" : "")">
                                    <span class="inline-block benefit-list-image pq-sprite @(string.Format(" offerIcon_{0}", offer.OfferCategoryId))">
                                    </span>
                                    <span class="inline-block benefit-list-title">
                                        @offer.OfferText
                                        @if (offer.IsOfferTerms)
                                        {
                                            <span class="tnc font9 margin-left5" id="@offer.OfferId">View terms</span>
                                        }
                                    </span>
                                </li>
                            }
                        </ul>
                        <div class="clear"></div>
                    </div>
                }
                @if (Model.PrimaryDealer.IsPremiumDealer && Model.PrimaryDealer.HasBenefits)
                {
                                    <!-- benefits -->
                    <div class="omega @(!Model.PrimaryDealer.IsStandardDealer && Model.PrimaryDealer.HasOffers ? " grid-6 padding-left30" : "grid-12 alpha offers-or-benefits")">
                        <p class="text-bold margin-bottom5">Benefits offered by this dealer</p>
                        <ul class="dealership-benefit-list">
                            @foreach (var benefit in Model.PrimaryDealer.Benefits)
                            {
                                <li>
                                    <span class="inline-block benefit-list-image pq-sprite @(string.Format(" benifitIcon_{0}", benefit.CatId))"></span>
                                    <span class="inline-block benefit-list-title">@benefit.BenefitText</span>
                                </li>
                            }
                        </ul>
                        <div class="clear"></div>
                    </div>
                }
                <div class="clear"></div>
            </div>
            <!-- offers and benefits ends here -->
        }

        @if (Model.PrimaryDealer.IsBookingAvailable)
        {
            <!-- booking starts here -->
            <div class="margin-right20 margin-left20 border-solid-bottom"></div>
            <div class="content-inner-block-20 font14">
                <p class="text-bold margin-bottom15">Book your bike from this dealer</p>
                <div class="grid-8 alpha">
                    <p class="margin-bottom10">Pay <span class="bwsprite inr-sm-dark"></span>@Bikewale.Utility.Format.FormatPrice(Model.PrimaryDealer.BookingAmount.ToString()) to book online and balance amount of <span class="bwsprite inr-sm-dark"></span>@Bikewale.Utility.Format.FormatPrice((Model.PrimaryDealer.TotalPrice - Model.PrimaryDealer.BookingAmount).ToString()) at the dealership</p>
                    <ul id="booking-benefits-list">
                        <li>Save on dealer visits</li>
                        <li>Secure online payments</li>
                        <li>Complete buyer protection</li>
                    </ul>
                    <div class="clear"></div>
                </div>
                <div class="grid-4 padding-top5">
                    <a href="/pricequote/bookingsummary_new.aspx?MPQ=" class="btn btn-teal book-now-btn btn-188-40">Book bike</a>
                </div>
                <div class="clear"></div>
            </div>
            <!-- booking ends here -->
        }

        @if (PrimaryDealerDetails != null)
        {
            <!-- disclaimer starts here -->
            <p id="disclaimerText" class="padding-left20 font11 padding-right20 padding-bottom20 text-x-light">
                <span id="read-less">
                    @if (Model.PrimaryDealer.IsPremiumDealer)
                    {
                        <span>The bike prices and EMI quote mentioned here are indicative and are provided by their authorized dealerships. BikeWale takes utmost care in gathering precise</span>
                    }
                    else
                    {
                        <span>The bike prices mentioned here are indicative and are provided by their authorized dealerships. BikeWale takes utmost care in gathering precise and accurate</span>
                    }
                    <a id="readmore" class="text-link">read more</a>
                </span>
                <span id="read-more"></span>
            </p>
            <!-- disclaimer ends here -->
        }
    </div>

    <!-- Terms and condition Popup start -->
    <div class="termsPopUpContainer content-inner-block-20 hide" id="termsPopUpContainer">
        <div class="fixed-close-btn-wrapper">
            <div id="termsPopUpCloseBtn" class="termsPopUpCloseBtn fixed-close-btn bwsprite cross-lg-lgt-grey cur-pointer"></div>
        </div>
        <h3>Terms and conditions</h3>
        <div class="hide" style="vertical-align: middle; text-align: center;" id="termspinner">
            <img class="lazy" data-original="https://imgd1.aeplcdn.com/0x0/bw/static/sprites/d/loader.gif" src="" />
        </div>
        <div id="terms" class="breakup-text-container padding-bottom10 font14">
        </div>
        <div id='orig-terms' class='hide'>
        </div>
    </div>
    <!-- Terms and condition Popup Ends -->

    if (Model.PrimaryDealer.EMIDetails != null && !Model.PrimaryDealer.IsStandardDealer)
    {
        <script type="text/javascript">

            var calculateEMI = function (loanAmount, tenure, rateOfInterest,proFees) {
                var interest, totalRepay, finalEmi;
                try {
                    interest = (loanAmount * tenure * rateOfInterest) / (12 * 100);
                    totalRepay = loanAmount + interest + proFees;
                    finalEmi = Math.ceil((totalRepay / tenure));
                }
                catch (e) {
                }
                return finalEmi;
            };

            var createSliderPoints = function(index,min,max,breaks,sliderType)
            {   var svar = "";
                try {
                    switch(sliderType)
                    {
                        case 1:
                            svar =  valueFormatter(Math.round(min + (index * (max - min)/breaks)));
                            break;
                        case 2:
                            svar =  Math.round(min + (index * (max - min)/breaks));
                            break;
                        default:
                            svar =  (min + (index * (max - min)/breaks)).toFixed(2);
                            break;
                    }
                } catch (e) {

                }
                return svar;
            };

            var LoanAmount = function (onRoadPrice, percentage) {
                var price;
                try {
                    price = (onRoadPrice * percentage) / 100;
                    price = Math.ceil(price / 100.0) * 100;
                }
                catch (e) {
                }
                return price;
            };

            var valueFormatter = function (num) {
                if(isNaN(num))
                {
                    if (num >= 100000) {
                        return (num / 100000).toFixed(1).replace(/\.0$/, '') + 'L';
                    }
                    if (num >= 1000) {
                        return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
                    }
                }

                return num;
            };

            var BikeEMI = function () {
                var self = this;
                self.breakPoints = ko.observable(5);
                self.bikePrice = ko.observable(bikeVersionPrice);
                self.minDnPay = ko.observable(@Model.PrimaryDealer.EMIDetails.MinDownPayment * bikeVersionPrice/100);
                self.maxDnPay = ko.observable(@Model.PrimaryDealer.EMIDetails.MaxDownPayment * bikeVersionPrice/100);
                self.minTenure = ko.observable(@Model.PrimaryDealer.EMIDetails.MinTenure);
                self.maxTenure = ko.observable(@Model.PrimaryDealer.EMIDetails.MaxTenure);
                self.minROI = ko.observable(@Model.PrimaryDealer.EMIDetails.MinRateOfInterest);
                self.maxROI = ko.observable(@Model.PrimaryDealer.EMIDetails.MaxRateOfInterest);
                self.processingFees = ko.observable(0);
                self.exshowroomprice = ko.observable(bikeVersionPrice);
                self.loan = ko.observable();

                self.tenure = ko.observable((self.maxTenure() - self.minTenure())/2 + self.minTenure());
                self.rateofinterest = ko.observable((self.maxROI() - self.minROI())/2 + self.minROI());
                self.downPayment = ko.pureComputed({
                    read: function () {
                        if (self.loan() == undefined || isNaN(self.loan()) || self.loan() == null)
                            self.loan(LoanAmount(self.exshowroomprice(), 70));
                        return ((LoanAmount(self.exshowroomprice(), 100)) - self.loan());
                    },
                    write: function (value) {
                        self.loan(((LoanAmount(self.exshowroomprice(), 100))) - value);
                    },
                    owner: this
                });

                self.monthlyEMI = ko.pureComputed({
                    read: function () {
                        return calculateEMI(self.loan(), self.tenure(), self.rateofinterest(),self.processingFees());
                    },
                    owner: this
                });
                self.totalPayable = ko.pureComputed({
                    read: function () {
                        return (self.downPayment() + (self.monthlyEMI() * self.tenure()));
                    },
                    owner: this
                });
            };

            docReady(function(){

                var EMISection = $("#EMISection");

                ko.bindingHandlers.slider = {
                    init: function (element, valueAccessor, allBindingsAccessor, bindingContext) {
                        var options = allBindingsAccessor().sliderOptions || {};
                        $("#" + element.id).slider(options);
                        ko.utils.registerEventHandler("#" + element.id, "slide", function (event, ui) {
                            var observable = valueAccessor();
                            observable(ui.value);
                        });
                    },
                    update: function (element, valueAccessor, allBindingsAccessor, bindingContext) {
                        var options = allBindingsAccessor().sliderOptions || {};
                        $("#" + element.id).slider(options);
                        var value = ko.utils.unwrapObservable(valueAccessor());
                        if (isNaN(value)) value = 0;
                        $("#" + element.id).slider("value", value);
                    }
                };

                if(EMISection)
                {
                    EMIviewModel = new BikeEMI;
                    ko.applyBindings(EMIviewModel, EMISection[0]);
                }
            })


        </script>
    }
}