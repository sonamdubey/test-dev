@model Bikewale.Entities.PriceQuote.LeadCaptureEntity
@if (Model != null)
{

    <!-- Lead Capture pop up start  -->
    <div id="leadCapturePopup" class="lead-popup @((Model.IsAmp || Model.IsApp) ? "lead-popup--active" : "") ">
        <div class="lead-popup-container">
            <div class="popup-inner-container">
                <div class="lead-popup__close-btn @(Model.IsAmp ? "onlyPopup-leadCapture-close-btn" : (Model.IsApp ? "inapp-leadCapture-close-btn" : "leadCapture-close-btn"))" @(Html.Raw(Model.IsApp ? "onclick=\"" + "Android.closeForm()" + "\"" : "")) data-act="MLA_Closed_Clicked"></div>

                <div id="contactDetailsPopup" class="contact-detail-screen">
                    @if (Model.OfferList != null && Model.ShowOffersOnLeadPage)
                    {
                        <div class="js_OffersSection" data-bind="visible: showOffers()">
                            <div class="lead-form-offers">
                                <div class="offers__head">
                                    <span class="offers-head__icon">
                                    </span>
                                    <p class="offers-head__title">
                                        offers
                                    </p>
                                </div>
                                <div class="offers__body">
                                    <ol class="offers__list">
                                        @foreach (var offer in Model.OfferList)
                                        {
                                            <li class="offers-list__item">
                                                @offer
                                            </li>
                                        }
                                    </ol>
                                    <div class="offers__action">
                                        @if (Model.OfferCount > 2)
                                        {
                                            <span class="offers-action__more-link">
                                                +@(Model.OfferCount - 2) More
                                            </span>
                                        }
                                        <div class="offers-action__tnc">
                                            <div class="tnc__info-icon">
                                                T&C Apply
                                                <div class="tnc__info-tooltip tooltip-icon-target tooltip-bottom">
                                                    <div class="bw-tooltip info-tooltip bw-tooltip--large">
                                                        <div class="bw-tooltip-text">
                                                            <ul>

                                                                <li>
                                                                    The offer is subject to two-wheeler availability at the dealerships
                                                                </li>
                                                                <li>
                                                                    BikeWale has brought this offer information on best effort basis and BikeWale is not liable for any consequential (or otherwise) loss / damage caused by the information
                                                                </li>
                                                                <li>
                                                                    All applicable terms and conditions would be as per the dealers and the same may change without any prior intimation
                                                                </li>
                                                                <li>
                                                                    For the final price, offer availability and exact details of the offers, kindly contact the dealerships
                                                                </li>
                                                            </ul>

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="lead-contact-detail__head">
                                <div>
                                    <p class="lead-contact-head__title" data-bind="text: (dealerHeading() && dealerHeading() != '') ? dealerHeading() : 'Provide details to avail offers'"></p>
                                    <p class="lead-contact-head__subtitle">Dealership will get back to you with offers, EMI quotes, exchange benefits and much more!</p>
                                </div>
                            </div>
                        </div>
                    }
                    <div class="lead-contact-detail__head" data-bind="visible: !showOffers()">
                        <span class="lead-popup__contact-icon icon-container--round"></span>
                        <div class="lead-popup__contact-desc">
                            <p class="lead-contact-head__title" data-bind="text: (dealerHeading() && dealerHeading() != '') ? dealerHeading() : 'Provide contact details'"></p>
                            <p class="lead-contact-head__subtitle" data-bind="text: (dealerDescription() && dealerDescription() != '') ? dealerDescription() : 'Dealership will get back to you with offers, EMI quotes, exchange benefits and much more!'"></p>
                        </div>

                    </div>


                    <div class="personal-info-form-container">
                        @if (Model.CityId <= 0)
                        {
                            <div class="slideIn-input-box-content margin-bottom15" data-bind="css: selectedCity() ? 'selection-done' : '',click : openCityList">
                                <div id="city-select-element" class="slideIn-input-box text-left">
                                    <p class="slideIn-input-label city-box-default text-left" data-bind="visible: (selectedCity() && selectedCity().cityName != ''),css : (selectedCity() && selectedCity().cityName != '') ? 'done' : '' ">City<sup>*</sup></p>
                                    <p id="city-select-p" class="selected-option-box city-box-default text-truncate" data-bind="text: (selectedCity() && selectedCity().cityName != '') ? selectedCity().cityName : 'Select City'"></p>
                                    <span class="boundary"></span>
                                    <span class="error-text hide"></span>
                                    <span class="bwmsprite grey-right-icon"></span>
                                </div>
                            </div>
                        }

                        <!-- ko if : isDealerBikes() -->
                        <div id="getLeadBike" class="form-control-box margin-bottom15">
                            <div class="input-select-box dealer-search-brand form-control-box">
                                <div class="dealer-search-brand-form font16 text-light-grey">
                                    <span id="selectedbike">Select a bike<sup>*</sup></span>
                                </div>
                                <span class="bwmsprite grey-right-icon"></span>
                                <span class="boundary"></span>
                                <span class="error-text"></span>
                                <span class="position-abt progress-bar"></span>
                            </div>
                        </div>
                        <div id="brandSearchBar">
                            <div class="dealer-brand-wrapper bwm-dealer-brand-box form-control-box text-left">
                                <div class="user-input-box">
                                    <span class="back-arrow-box"><span class="bwmsprite back-long-arrow-left"></span></span>
                                    <input class="form-control" type="text" id="assistanceBrandInput" placeholder="Select a bike" />
                                </div>
                                <ul id="sliderBrandList" class="slider-brand-list margin-top40" data-bind="foreach: dealerBikes ">
                                    <li data-bind="attr: { modelid: model.modelid, bikeName: bike, versionId: version.versionId }, text: bike, click:  function (data, event) { return $root.selectedBike($data); }"></li>
                                </ul>
                            </div>
                        </div>
                        <!-- /ko -->
                        <div class="input-box form-control-box margin-bottom5">
                            <input type="text" id="getFullName" data-bind="textInput: fullName" maxlength="50">
                            <label for="getFullName">Name<sup>*</sup></label>
                            <span class="boundary"></span>
                            <span class="error-text hide"></span>
                        </div>
                        <div class="input-box input-number-box form-control-box margin-bottom15">
                            <input type="tel" maxlength="10" id="getMobile" data-bind="textInput: mobileNo">
                            <label for="getMobile">Mobile number<sup>*</sup></label>
                            <span class="input-number-prefix">+91</span>
                            <span class="boundary"></span>
                            <span class="error-text hide"></span>
                        </div>
                        <div class="input-box form-control-box margin-bottom15" data-bind="visible : emailRequired() && (mfgCampaignId() > 0)">
                            <input type="email" id="getEmailID" data-bind="textInput: emailId" maxlength="50">
                            <label for="getEmailID" data-bind="visible: emailOption() == 'Required'">Email<sup>*</sup></label>
                            <label for="getEmailID" data-bind="visible : emailOption()== 'Optional'">Email (optional)</label>
                            <span class="boundary"></span>
                            <span class="error-text hide"></span>
                        </div>
                        <div id="getPinCode-input-box" class="input-box form-control-box margin-bottom15" data-bind="visible: pinCodeRequired()">
                            <input type="text" id="getPinCode" autocomplete="off" maxlength="6">
                            <label for="getPinCode">Pincode<sup>*</sup></label>
                            <span class="boundary"></span>
                            <span class="error-text hide"></span>
                            <ul id="errPinCodeSearch" class="ui-autocomplete ui-front ui-menu ui-widget hide">
                                <li class="ui-menu-item" tabindex="-1">
                                    <span class="text-bold">Oops! No suggestions found</span><br>
                                    <span class="text-light-grey font12">Search by pincode or area e.g: 400708 or airoli</span>
                                </li>
                            </ul>
                        </div>
                        <div id="getDealer-select-box" class="form-control-box margin-bottom30 full-width-select text-left position-rel" data-bind="visible: dealersRequired()">
                            <div class="dropdown-select-wrapper position-rel">
                                <span id="dealerDropdownLabel" class="font16 text-light-grey">Select dealer</span>
                                <select id="ddlMfgDealers" data-title="Select dealer" class="dropdown-select"></select>
                                <span class="boundary"></span>
                                <span class="error-text hide"></span>
                            </div>
                        </div>
                        <div class="clear"></div>
                        <button class="btn btn-orange contact-details__submit" id="user-details-submit-btn" data-bind="click: function(data, event){ @(Model.IsMLAActive && !Model.IsManufacturerCampaign ? "getMLADealers();" : "") submitLead(data, event); }, text: showOffers() ? 'Claim Offers' : 'Submit' ">Submit</button>
                        <p class="agreement-and-policy">By proceeding ahead, you agree to BikeWale <span id="visitor-agreement-link" class="terms-target-link" data-link=2>visitor agreement</span>&nbsp;and&nbsp;<span id="privacy-policy-link" class="terms-target-link" data-link=1>privacy policy</span>.</p>
                    </div>
                </div>
                <div class="additional-screen">
                    <!-- thank you message starts here -->
                    <div id="notify-response" class="notify-response__container" data-bind="css:{'dealer-message__content': dealerMessage()}">
                        <div class="lead-popup__thankyou-icon icon-container--round">
                        </div>
                        <p class="lead-popup-thankyou__title">Thank you <span class="notify-leadUser"></span></p>
                        <!-- ko if : !dealerMessage() -->
                        <p class="lead-popup-thankyou__desc">Thank you for providing your details. <span data-bind="text : dealerName()"></span><span data-bind="visible  : dealerArea() && dealerArea().length> 0, text: ', ' + dealerArea()"></span>&nbsp; will get in touch with you soon.</p>
                        <!-- /ko -->
                        <!-- ko ifnot : !dealerMessage() -->
                        <p class="thankyou-with-code" id="ko_thankyoumessage" data-bind="html: dealerMessage()">
                        </p>
                        <!-- /ko -->
                        <input type="button" id="notifyOkayBtn" class="btn btn-orange notify-response__submit" value="Okay" @(Html.Raw(Model.IsApp ? "onclick=\"" + "Android.leadSubmit()" + "\"" : "")) />
                    </div>
                    <!-- thank you message ends here -->
                    @if (Model.IsMLAActive && !Model.IsManufacturerCampaign)
                    {
                        <div id="otherDealers" class="dealers__container">
                            <div class="dealers__content selection-container">
                                <div class="dealers__head">
                                    <div class="dealers-head__left">
                                        <p class="dealer-head__title">
                                            Other Dealers
                                        </p>
                                        <p class="dealer-head__subtitle">
                                            Check offers from other dealers
                                        </p>
                                    </div>
                                    <div class="dealer-head__right">
                                        <label class="checkbox-toggle checkbox-container">
                                            <input type="checkbox" class="checkbox-container__input" id="selectAll" data-bind="click: modifyMLADealerIds , checked: isSelectAllChecked" />
                                            <span class="checkbox-container__label">
                                                Select All
                                            </span>
                                            <span class="checkbox-container__icon">
                                            </span>

                                        </label>
                                    </div>
                                </div>
                                <ul class="dealers__list selection-checkbox-container" data-bind="foreach: MLADealers">
                                    <li class="dealers-list__item">
                                        <label>
                                            <span class="dealers-item__content">
                                                <span class="dealers-item__name" data-bind="text: name">

                                                </span>
                                                <span class="dealers-item__info">
                                                    <span class="dealers__location dealer-info__item" data-bind="text: area">

                                                    </span>
                                                    <span class="dealers__distance dealer-info__item" data-bind="text: distance">

                                                    </span>
                                                </span>
                                            </span>
                                            <span class="checkbox-container">
                                                <input type="checkbox" class="checkbox-container__input" data-bind="checkedValue: dealerId, checked: $parent.selectedMLADealerIds" />
                                                <span class="checkbox-container__icon"></span>
                                            </span>
                                        </label>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="dealers__btn-container">
                            <button id="otherDealerBtn" class="btn btn-orange dealers__submit-btn" data-bind="enable : selectedMLADealerIds().length != 0, click:submitLeadToMLADealers">
                                Submit
                            </button>
                            <button id="otherDealerSkipBtn" class="dealers__skip-btn" data-act="MLA_Not_Interested_Clicked" data-bind="click: triggerMlaGAs">
                                not interested
                            </button>
                        </div>

                    }
                </div>

                @if (Model.CityId <= 0)
                {
                <!-- city drawer starts here -->
                    <div id="pqcity-slideIn-drawer" class="slideIn-drawer-container">
                        <div class="form-control-box text-left">
                            <div class="drawer-top-header">
                                <div>
                                    <span id="close-city-filter" class="back-arrow-box inline-block" data-bind="click : closeCityList">
                                        <span class="bwmsprite back-long-arrow-left"></span>
                                    </span><p class="head-label inline-block">Select city</p>
                                </div>
                                <div class="filter-input-box">
                                    <div class="form-control-box">
                                        <input type="text" id="city-search-box" class="form-control padding-right40" placeholder="Type to select city" data-bind="textInput:cityFilter" autocomplete="off">
                                        <span class="bwmsprite search-icon-grey"></span>
                                    </div>
                                </div>
                            </div>
                            <ul class="filter-list" id="pqpopupCityList" data-bind="template: { name: 'pqbindCityList-template', foreach: visibleCities }"></ul>
                            <script type="text/html" id="pqbindCityList-template">
                                <li data-bind="click: $parent.selectCity , attr: { 'cityId': cityId }">
                                    <span data-bind="text: cityName"></span>
                                </li>
                            </script>
                        </div>
                    </div>
                <!-- city drawer ends here -->
                }
            </div>
        </div>
    </div>
    <div id="ub-ajax-loader">
        <div class="cover-popup-loader"></div>
    </div>

    <div id="policyPopup" class="bw-popup bwm-fullscreen-popup hide">
        <div class="popup-inner-container">
            <span class="bwmsprite close-btn policy-close-btn"></span>
            <div id="policyPopupContainer" class="policy-container">

            </div>
        </div>
    </div>

    <!-- Lead Capture pop up end  -->

    <script type="text/javascript">

        var gaLabel = "";
        var eventAction = "Lead_Submitted";
        var leadBtnBookNow, leadCapturePopup, leadBike;
        var fullName, emailid, mobile, detailsSubmitBtn;
        var prevEmail = "", prevMobile = "", prevPinCode = "";
        var leadmodelid = parseInt('@Model.ModelId'), leadcityid = parseInt('@Model.CityId'), leadareaid = parseInt('@Model.AreaId');
        var leadBikeName = '@Model.BikeName', leadLocation = '@Model.Location', CityArea = leadLocation;
        var objPinCodes = new Object(), validate, validateInputSelection;
        var brandSearchBar, dealerSearchBrand, dealerSearchBrandForm, windowScreen;
        var dropdown;
        var fbPixelLeadEvent = "";
        var LeadPopupOriginEnum = {"Finance":1,"NonFinance":2};
        var showOffersOnPopup = '@Convert.ToString(Model.ShowOffersOnLeadPage).ToLower()' == "true";
        

        function leadModel() {
            var arr = setuserDetails();
            var globalLocation = GetGlobalLocationObject();
            var self = this;
            if (arr != null && arr.length > 0) {
                self.fullName = ko.observable(arr[0] || '');
                self.emailId = ko.observable((arr[1] && arr[1] != 'undefined') ? arr[1] : '');
                self.mobileNo = ko.observable(arr[2] || '');
            }
            else {
                self.fullName = ko.observable();
                self.emailId = ko.observable();
                self.mobileNo = ko.observable();
            }
            self.msg = "";
            self.pincode = ko.observable();
            self.IsVerified = ko.observable(false);
            self.pqId = ko.observable(0);
            self.pqGUId = ko.observable("");
            self.dealerId = ko.observable();
            self.modelId = ko.observable(leadmodelid);
            self.versionId = ko.observable();
            self.cityId = ko.observable(leadcityid);
            self.areaId = ko.observable(leadareaid);
            self.dealerName = ko.observable();
            self.leadSourceId = ko.observable();
            self.dealerArea = ko.observable();
            self.pqSourceId = ko.observable();
            self.pageUrl = window.location.href;
            self.clientIP = "";
            self.cityFilter = ko.observable("");
            self.isRegisterPQ = ko.observable(false);
            self.isDealerBikes = ko.observable(false);
            self.dealerBikes = ko.observableArray([]);
            self.selectedBike = ko.observable();
            self.campaignId = ko.observable();
            self.mfgCampaignId = ko.observable();
            self.GAObject = ko.observable();
            self.dealerHeading = ko.observable();
            self.dealerMessage = ko.observable();
            self.dealerDescription = ko.observable();
            self.cityRequired = ko.observable(leadcityid <= 0);
            self.pinCodeRequired = ko.observable();
            self.emailRequired = ko.observable();
            self.emailOption = ko.observable();
            self.dealersRequired = ko.observable();
            self.dealerCityName = ko.observable();
            self.dealerAreaName = ko.observable();
            self.eventCategory = ko.observable();
            self.cities = ko.observableArray();
            self.selectedCity = ko.observable();
            self.ko_DealerName = ko.observable();
            self.sendLeadSMSCustomer = ko.observable(false);
            self.organizationName = ko.observable();
            self.leadId = ko.observable(0);
            self.selectedMLADealerIds = ko.observableArray([]);
            self.MLADealers = ko.observableArray([]);
            self.isBikeSelected = ko.observable(false);
            self.isUserAreaAvailable = ko.computed(function(){
                return self.cityId() == globalLocation.CityId && globalLocation.AreaId > 0;
            });
            self.leadPopupOrigin = ko.observable(LeadPopupOriginEnum.NonFinance);
            self.showOffers = ko.computed(function(){return parseInt(self.leadPopupOrigin()) != LeadPopupOriginEnum.Finance  && showOffersOnPopup }) ;

            self.selectedBike.subscribe(function (data) {
                if(data != null && (gaObj.id == gaEnum.Dealer_Locator_City_Page  || gaObj.id == gaEnum.Dealer_Locator_Details_Page) && !self.isBikeSelected())
                {
                    @if (Model.IsMLAActive && !Model.IsManufacturerCampaign)
                {
                    <text>
                    triggerNonInteractiveGA(gaObj.name, "MLA_Eligible_Lead_Popup_Shown", self.selectedBike().bike + "_" + (self.isUserAreaAvailable() ? globalLocation.CityName : self.dealerCityName()) + "_" + (self.isUserAreaAvailable()  ? globalLocation.AreaName : null));
                    </text>
                }
                    self.isBikeSelected(true);
                }
            });
            function Dealer(dealerId, name, area, distance, areaId) {
                this.dealerId = dealerId;
                this.name = name;
                this.area = area;
                this.distance = distance != 0 ? (distance != Math.round(distance) ? distance.toFixed(1): distance) + " Kms" : "";
                this.areaId = areaId;
            }

            @if (Model.IsMLAActive && !Model.IsManufacturerCampaign)
        {
             <text>
            self.setMLADealers = function(mlaDealers){
                if (mlaDealers != undefined && mlaDealers.length > 0){
                    self.MLADealers.removeAll();
                    mlaDealers.forEach(function(dealer) {
                        if(dealer.DealerId != self.dealerId())
                        {
                            var dealerDistance = self.isUserAreaAvailable() ? dealer.Distance : 0;
                            self.MLADealers.push(new Dealer(dealer.DealerId, dealer.Name, dealer.Area, dealerDistance, dealer.AreaId));
                        }
                    });
                    if (self.MLADealers() != null && self.MLADealers().length > 0) {
                        $('.additional-screen').addClass('dealers--active');
                    }
                }
            };
            self.getMLADealers = function(){
                var isValidUserDetails = self.validateUserInfo(fullName, emailid, mobile);
                if(isValidUserDetails)
                {
                    if(gaObj.id == gaEnum.Dealer_Locator_City_Page || gaObj.id == gaEnum.Dealer_Locator_Details_Page)
                    {
                        if(self.selectedBike() != null && self.selectedBike().model.modelId > 0)
                        {
                            var url = "/api/dealers/model/"+ self.selectedBike().model.modelId + "/city/" + leadcityid + "/dealerId/" + self.dealerId() + "/?areaId=" + (self.isUserAreaAvailable() ? globalLocation.AreaId : "0");
                            $.getJSON(url, function(data) {
                                self.setMLADealers(data);
                                triggerNonInteractiveGA(gaObj.name,"MLA_Primary_Lead_Success_" + self.MLADealers().length + "_dealers_shown", self.selectedBike().bike +"_" +  (self.isUserAreaAvailable() ? globalLocation.CityName : self.dealerCityName() )+ "_" + (self.isUserAreaAvailable()  ? globalLocation.AreaName : "null"));
                            });
                        }
                    }
                    else {
                        self.setMLADealers(@Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.MLADealers)));
                        triggerNonInteractiveGA(gaObj.name,"MLA_Primary_Lead_Success_" + self.MLADealers().length + "_dealers_shown", "@Model.BikeName" + "_" +  "@Model.City" + "_" + "@Model.Area");
                    }
                }
            };
            self.modifyMLADealerIds = ko.computed({
                read: function() {
                },
                write: function(value,event) {
                    if(!self.isSelectAllChecked())
                    {
                        self.selectedMLADealerIds([]);
                        ko.utils.arrayForEach(self.MLADealers(), function (dealer) {
                            self.selectedMLADealerIds.push(dealer.dealerId);
                        });
                    }
                    else{
                        self.selectedMLADealerIds([]);
                    }
                    if(gaObj.id == gaEnum.Model_Page || gaObj.id == gaEnum.DealerPriceQuote_Page)
                    {
                        triggerGA(gaObj.name,"MLA_Select All_Clicked","@Model.BikeName" + "_" +  "@Model.City" + "_" + "@Model.Area");
                    }
                    else{
                        triggerGA(gaObj.name,"MLA_Select All_Clicked",self.selectedBike().bike +"_" +  (self.isUserAreaAvailable() ? globalLocation.CityName : self.dealerCityName() )+ "_" + (self.isUserAreaAvailable() ? globalLocation.AreaName : "null"));
                    }
                }
            }).extend({ rateLimit: 1 });

            self.isSelectAllChecked = ko.computed(function() {
                return (self.selectedMLADealerIds().length == self.MLADealers().length);
            }).extend({rateLimit: 1});

            self.triggerMlaGAs = function(data, event) {
                if(gaObj.id == gaEnum.Model_Page || gaObj.id == gaEnum.DealerPriceQuote_Page)
                {
                    triggerGA(gaObj.name,event.target.dataset.act,"@Model.BikeName" + "_" +  "@Model.City" + "_" + "@Model.Area");
                }
                else{
                    if(self.selectedBike() != null)
                    {
                        triggerGA(gaObj.name,event.target.dataset.act,self.selectedBike().bike +"_" +  (self.isUserAreaAvailable()  ? globalLocation.CityName : self.dealerCityName() )+ "_" + (self.isUserAreaAvailable() ? globalLocation.AreaName : null));
                    }
                }
            };
            </text>
        }
            self.triggerCloseBtnGA = function(event) {
                @if(Model.IsMLAActive && !Model.IsManufacturerCampaign) {
                <text>
                if (LeadPopupStateEnum.Final == LeadPopupState.status)
                {
                    self.triggerMlaGAs(null, event);
                }
                </text>
            }
            };

            self.submitLeadToMLADealers = function(){
                var objCust = {
                    "dealerId": self.dealerId(),
                    "pqId": self.pqGUId(),
                    "customerName": self.fullName(),
                    "customerMobile": self.mobileNo(),
                    "customerEmail": self.emailId(),
                    "versionId": self.versionId(),
                    "cityId": self.cityId(),
                    "cityName": self.isUserAreaAvailable() ? globalLocation.CityName : self.dealerCityName(),
                    "areaId": self.isUserAreaAvailable() ? globalLocation.AreaId : 0,
                    "areaName": self.isUserAreaAvailable() ? globalLocation.AreaName : 0,
                    "leadSourceId": (gaObj.id == gaEnum.Dealer_Locator_City_Page ? "52" : (gaObj.id == gaEnum.Dealer_Locator_Details_Page ? "54" : @Model.MlaLeadSourceId)),
                    "pinCode": self.pincode() || 0,
                    "deviceId": getCookie('BWC'),
                    "campaignId": self.campaignId(),
                    "manufacturerDealerId": $('#ddlMfgDealers :selected').data('id'),
                    "manufacturerDealer": self.ko_DealerName(),
                    "bikeName": leadBikeName,
                    "dealerName": self.organizationName() ? self.organizationName() : self.dealerName(),
                    "sendLeadSMSCustomer": self.sendLeadSMSCustomer(),
                    "leadId":self.leadId(),
                    "dealerIds":self.selectedMLADealerIds(),
                    "platformId": @Model.PlatformId,
                    "pageId": @Model.PageId
                    };
                // 3 represents modelpage and 8 represents dealerprice quote page
                if(gaObj.id == gaEnum.Model_Page || gaObj.id == gaEnum.DealerPriceQuote_Page || gaObj.id == gaEnum.PriceInCity_Page)
                {
                    triggerGA(gaObj.name,"MLA_Lead_Success_" + self.selectedMLADealerIds().length + "/" + self.MLADealers().length + "_dealers_Lead Submitted", "@Model.BikeName" + "_" +  "@Model.City" + "_" + "@Model.Area");
                }
                else{
                    triggerGA(gaObj.name,"MLA_Lead_Success_" + self.selectedMLADealerIds().length + "/" + self.MLADealers().length + "_dealers_Lead Submitted", self.selectedBike().bike +"_" +  (self.isUserAreaAvailable() ? globalLocation.CityName : self.dealerCityName() )+ "_" + (self.isUserAreaAvailable() ? globalLocation.AreaName : "null"));
                }
                $.ajax({
                    type: "POST",
                    url: "/api/submitmlaleads/",
                    data: ko.toJSON(objCust),
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('utma', getCookie('__utma'));
                        xhr.setRequestHeader('utmz', getCookie('_bwutmz'));
                    },
                    async: true,
                    contentType: "application/json",
                    dataType: 'json',
                    success: function (response) {
                    }
                });
            };

            @if (Model.CityId <= 0)
            {
                        <text>
            self.FilterData = function (data, filter) {
                filterObj = data;
                if (filter && filter.length > 1) {
                    var pat = new RegExp(filter, "i");
                    filterObj = data.filter(function (place) {
                        if (pat.test(place.cityName)) return place;
                    });

                }
                return filterObj;
            };

            self.visibleCities = ko.computed(function () {
                return self.FilterData(self.cities(), self.cityFilter());
            });

            self.openCityList = function () {
                var cityListContainer = $('#pqcity-slideIn-drawer');
                cityListContainer.show('slide', { direction: 'right' }, 500, function () {
                    cityListContainer.addClass('fix-header-input');
                });

                if ($(document).height() > $(window).height()) {
                    var windowScrollTop = windowScreen.htmlElement.scrollTop() ? windowScreen.htmlElement.scrollTop() : windowScreen.bodyElement.scrollTop();
                    if (windowScrollTop < 0) {
                        windowScrollTop = 0;
                    }
                    windowScreen.htmlElement.addClass('lock-browser-scroll').css('top', -windowScrollTop);
                }
            };

            self.closeCityList = function () {
                var cityListContainer = $('#pqcity-slideIn-drawer');
                cityListContainer.hide('slide', { direction: 'right' }, 500, function () { });
                cityListContainer.removeClass('fix-header-input');
                windowScreen.unlock();
            };

            self.getModelCities = function (d, e) {
                if (self.modelId() > 0 && self.cityRequired()) {
                    var eleCities = $("#getLeadCity");
                    $.ajax({
                        type: "GET",
                        url: "/api/PQCityList/?modelId=" + self.modelId(),
                        dataType: 'json',
                        success: function (response) {
                            var cities = response.cities;
                            var citySelected = null;
                            if (cities) {
                                self.cities(cities);
                            }
                            else {
                                self.cities([]);
                            }
                            eleCities.trigger("chosen:updated");
                            $(this).parent().removeClass('done');
                        }
                    });
                }
            };

            self.selectCity = function (d, e) {
                self.selectedCity(d);
                if (self.selectedCity() && self.selectedCity().cityId > 0) {
                    self.cityId(self.selectedCity().cityId);

                    if (self.dealersRequired()) {
                        self.getDealersList(self.dealerId());
                    }

                    self.isRegisterPQ(true);
                }
                self.closeCityList();
                self.validateCity();
            };
            </text>
            }

            self.setOptions = function (options) {
                if (options != null) {
                    if (options.eventcategory != null)
                        self.eventCategory(options.eventcategory);

                    if (options.dealercityname != null)
                        self.dealerCityName(options.dealercityname);

                    if (options.dealerareaname != null)
                        self.dealerAreaName(options.dealerareaname);

                    if (options.dealerid != null)
                        self.dealerId(options.dealerid);

                    if (options.dealername != null)
                        self.dealerName(options.dealername);

                    if (options.dealerarea != null)
                        self.dealerArea(options.dealerarea);

                    if (options.versionid != null)
                        self.versionId(options.versionid);

                    if (options.leadsourceid != null)
                        self.leadSourceId(options.leadsourceid);

                    if (options.pqsourceid != null)
                        self.pqSourceId(options.pqsourceid);

                    if (options.isregisterpq != null)
                        self.isRegisterPQ(options.isregisterpq);

                    if (options.campaignId != null)
                        self.campaignId(options.campaignId);

                    if (options.mfgCampid != null) {
                        self.mfgCampaignId(options.mfgCampid);
                    }

                    if (options.isdealerbikes != null && options.isdealerbikes) {
                        self.isDealerBikes(options.isdealerbikes);
                        self.getDealerBikes();
                    }
                    if (options.dealerHeading != null && options.dealerHeading != "")
                        self.dealerHeading(options.dealerHeading);

                    if (options.dealerMessage != null && options.dealerMessage != "")
                        self.dealerMessage(options.dealerMessage);

                    if (options.dealerDescription != null && options.dealerDescription != "")
                        self.dealerDescription(options.dealerDescription);

                    if (options.pinCodeRequired != null)
                        self.pinCodeRequired(options.pinCodeRequired != 'True' ? false : true);

                    if (options.emailRequired != null)
                    {
                        self.emailRequired(options.emailRequired != 'Not_Required');
                        self.emailOption(options.emailRequired);
                    }

                    if (options.dealersRequired != null) {
                        self.dealersRequired(options.dealersRequired != 'True' ? false : true);
                        if (self.cityId() && self.dealersRequired()) {
                            self.getDealersList(self.dealerId());
                        }
                    }

                    if (self.cityRequired()) {
                        self.getModelCities();
                    }

                    if (options.pageurl != null)
                        self.pageUrl = options.pageurl;

                    if (options.clientip != null)
                        self.clientIP = options.clientip;


                    if (options.pqid != null && options.pqid)
                        self.pqId(options.pqid);

                    if (options.pqguid != null && options.pqguid)
                        self.pqGUId(options.pqguid);

                    if (options.gaobject != null)
                        self.GAObject(options.gaobject);

                    if (options.sendLeadSMSCustomer != null) {
                        self.sendLeadSMSCustomer(options.sendLeadSMSCustomer);
                    }

                    if (options.organizationName != null) {
                        self.organizationName(options.organizationName);
                    }
                    
                    self.leadPopupOrigin(options.leadPopupOrigin != null ? options.leadPopupOrigin : LeadPopupOriginEnum.NonFinance);
                    
                    self.isBikeSelected(false);
                }
            };

            self.getDealerBikes = function (data, event) {

                if (!isNaN(self.dealerId()) && self.dealerId() > 0 && self.campaignId() > 0) {
                    var dealerKey = "dealerDetails_" + self.dealerId() + "_camp_" + self.campaignId();
                    var dealerInfo = lscache.get(dealerKey);

                    if (!dealerInfo) {

                        startLoading(leadBike);
                        leadBike.find(".btnSpinner").show();

                        $.ajax({
                            type: "GET",
                            url: "/api/DealerBikes/?dealerId=" + self.dealerId() + "&campaignId=" + self.campaignId(),
                            contentType: "application/json",
                            dataType: 'json',
                            beforeSend: function (xhr) {
                                self.showLoader();
                                xhr.setRequestHeader('utma', getCookie('__utma'));
                                xhr.setRequestHeader('utmz', getCookie('_bwutmz'));
                            },
                            success: function (response) {
                                lscache.set(dealerKey, response, 30);
                                obj = ko.toJS(response);
                                self.dealerBikes([]);
                                self.dealerBikes(obj.dealerBikes);
                            },
                            complete: function (xhr) {
                                self.hideLoader();
                                if (xhr.status == 204 || xhr.status == 404) {
                                    lscache.set(dealerKey, null, 30);
                                }

                                stopLoading(leadBike);
                                leadBike.find(".btnSpinner").hide();
                            }
                        });
                    }
                    else {
                        obj = ko.toJS(dealerInfo);
                        self.dealerBikes([]);
                        self.dealerBikes(obj.dealerBikes);
                    }
                }
            };

            self.getDealersList = function () {
                $.ajax({
                    type: "GET",
                    url: "/api/ManufacturerCampaign/city/" + self.cityId() + "/dealer/" + self.dealerId() + "/",
                    contentType: "application/json",
                    dataType: 'json',
                    complete: function (xhr, ajaxOptions, thrownError) {
                        if (xhr.status != 200){
                            $("#ddlMfgDealers").html('');
                            $("#ddlMfgDealers").append("<option value selected>No dealer present</option>");
                            $("#getDealer-select-box").find(".dropdown-menu").remove();
                            dropdown.setMenu($("#ddlMfgDealers"));
                        }
                    },
                    success: function (response) {
                        $("#dealerDropdownLabel").hide();
                        var obj = ko.toJS(response);
                        var count = obj.length;
                        var objMfgDealers = $("#ddlMfgDealers");

                        if (count >= 1) {
                            objMfgDealers.html('');
                            if (count > 1) { objMfgDealers.append("<option value selected>Select dealer</option>"); }
                            for (i = 0; i < count; i++) {
                                var dt = obj[i];
                                var areaName = '';
                                if (dt.area != null) {
                                    areaName = ", " + dt.area;
                                }
                                objMfgDealers.append("<option value=" + (i + 1) + " data-id='" + dt.id + "'  >" + dt.dealerName + areaName + "</option>");
                            }
                            if (count == 1) {
                                objMfgDealers.val('0');
                                objMfgDealers.closest('.select-box').addClass('done');
                            }
                        }
                        $("#getDealer-select-box").find(".dropdown-menu").remove();
                        dropdown.setMenu(objMfgDealers);
                    },
                });
            };

            self.generatePQ = function (data, event) {

                isSuccess = false;
                isValidDetails = false;

                isValidDetails = self.validateUserInfo(fullName, emailid, mobile);

                if (self.isDealerBikes()) {
                    var bike = self.selectedBike();
                    if (bike && bike.version && bike.model) {
                        self.versionId(bike.version.versionId);
                        self.modelId(bike.model.modelId);
                    }
                    else {
                        self.versionId(0);
                        self.modelId(0);
                    }
                }

                if (isValidDetails && self.modelId() && self.versionId()) {

                    var objData = {
                        "dealerId": self.dealerId(),
                        "modelId": self.modelId(),
                        "versionId": self.versionId(),
                        "cityId": self.cityId(),
                        "areaId": self.areaId(),
                        "clientIP": self.clientIP,
                        "pageUrl": self.pageUrl,
                        "sourceType": @(Model.PlatformId != 0 ? Model.PlatformId : 2),
                        "pQLeadId": self.pqSourceId(),
                        "deviceId": getCookie('BWC')
                    };
                    return self.registerPQ(objData);

                }
                return isSuccess;

            };

            self.registerPQ = function (objPQData) {
                var isSuccess = false;
                if (objPQData) {
                    var url = '/api/v1/registerpq/';
                    $.ajax({
                        type: "POST",
                        url: url,
                        async: false,
                        data: ko.toJSON(objPQData),
                        contentType: "application/json",
                        dataType: 'json',
                        beforeSend: function (xhr) {
                            self.showLoader();
                        },
                        success: function (response) {
                            self.pqGUId(response.quoteId);
                            isSuccess = true;
                            if (typeof (gaObj) != "undefined" && gaObj.id == 3)
                            {
                                trackPQSources(response.quoteId, objPQData.pQLeadId, 2, objPQData.versionId);
                            }
                        },
                        complete: function (xhr) {
                            self.hideLoader();
                            if (xhr.status != 200) {
                                self.IsVerified(false);
                                isSuccess = false;
                                stopLoading($("#user-details-submit-btn").parent());
                            }

                        }
                    });
                }

                return isSuccess;
            };

            self.pushToGA = function (data, event) {

                if (data != null && data.act != null) {
                    if (data.lab == "lead_label") {
                        data.lab = self.selectedBike().make.makeName + '_' + self.selectedBike().model.modelName + '_' + CityArea;
                    }
                    triggerGA(data.cat, data.act, data.lab)
                }
            };

            self.verifyCustomer = function (data, event) {

                if (self.isRegisterPQ())
                    self.generatePQ(data, event);

                if ((self.pqGUId() || self.pqId()) && self.dealerId()) {
                    var isOldPQ = self.pqId() && self.pqId() != 0;
                    var url = isOldPQ ? "/api/PQCustomerDetail/" : "/api/v1/PQCustomerDetail/";
                    var objCust = {
                        "dealerId": self.dealerId(),
                        "pqId": isOldPQ ? self.pqId() : self.pqGUId(),
                        "versionId": self.versionId(),
                        "cityId": self.cityId(),
                        "customerName": self.fullName(),
                        "customerMobile": self.mobileNo(),
                        "customerEmail": self.emailId(),
                        "clientIP": clientIP,
                        "PageUrl": pageUrl,
                        "leadSourceId": self.leadSourceId(),
                        "deviceId": getCookie('BWC'),
                        "areaId": self.isUserAreaAvailable() ? globalLocation.AreaId : "0",
                        "platformId": @Model.PlatformId,
                        "pageId": @Model.PageId,
                        "campaignId": self.campaignId()
                    };
                    $.ajax({
                        type: "POST",
                        url: url,
                        data: ko.toJSON(objCust),
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('utma', getCookie('__utma'));
                            xhr.setRequestHeader('utmz', getCookie('_bwutmz'));
                        },
                        async: true,
                        contentType: "application/json",
                        dataType: 'json',
                        success: function (response) {
                            var obj = ko.toJS(response);
                            self.IsVerified(obj.isSuccess);
                            if(!isOldPQ) self.leadId(obj.leadId);
                        },
                        complete: function (xhr, ajaxOptions, thrownError) {
                            if (xhr.status != 200)
                                self.IsVerified(false);
                        }
                    });
                }
            };

            self.submitLead = function (data, event) {

                $("#personalInfo").hide();
                try {
                    if (self.selectedBike() != null)
                        gaLabel = gaLabel = self.selectedBike().bike + "_" + self.dealerCityName() + ((self.dealerAreaName() != null) ? ("_" + self.dealerAreaName()) : "");

                    if (self.mfgCampaignId() > 0) {
                        self.submitCampaignLead(data, event);
                        self.triggerABTestGA(gaLabel);
                    }
                    else {

                        self.IsVerified(false);

                        isValidDetails = self.validateUserInfo(fullName, emailid, mobile);
                        if (self.dealerId() && isValidDetails) {
                            self.verifyCustomer();
                            LeadPopupState.setFinalScreen();
                            if (self.IsVerified()) {
                                triggerGA(self.eventCategory(), eventAction, gaLabel);
                            }
                            setPQUserCookie();
                            self.triggerABTestGA(gaLabel);
                            if(fbPixelLeadEvent)
                            {
                                fbq('track', fbPixelLeadEvent);
                            }
                        }
                    }

                    /* <![CDATA[ */
                    window.google_trackConversion({
                        google_conversion_id: 998187973,
                        google_conversion_language: "en",
                        google_conversion_format: "3",
                        google_conversion_color: "ffffff",
                        google_conversion_label: "vUR5CPXFq3EQxcf82wM",
                        google_remarketing_only: false
                    });
                    // ]]>
                } catch (e) {
                    console.log(e.message);
                }
            };

            self.validateUserInfo = function () {
                var isValid = true;

                isValid &= self.validateCity();

                isValid &= self.validateUserName();

                isValid &= self.validateEmailId();

                isValid &= self.validateMobileNo();

                if (self.pinCodeRequired()) {
                    isValid &= self.validatePinCode();

                }

                if (self.dealersRequired()) {
                    isValid &= self.validateDealer();
                }
                if (self.isDealerBikes())
                    isValid &= self.validateBike();
                return isValid;
            };

            self.validateDealer = function (inputName) {
                var isValid = false;
                if ($('#ddlMfgDealers').val() == "") {
                    validate.setError($('#ddlMfgDealers'), 'Please select dealer');
                }
                else {
                    isValid = true;
                    validate.setError($('#ddlMfgDealers'), '');
                }
                return isValid;
            };

            self.validateUserName = function () {
                leadUsername = fullName;
                var isValid = false;
                var regMaxLen = /^[a-zA-Z ]{1,50}$/;
                if (self.fullName() != null && self.fullName().trim() != "") {
                    nameLength = self.fullName().length;

                    if (self.fullName().indexOf('&') != -1) {
                        validate.setError(leadUsername, 'Invalid name');
                        isValid = false;
                    }
                    else if (nameLength == 0) {
                        validate.setError(leadUsername, 'Please enter your name');
                        isValid = false;
                    }
                    else if (!regMaxLen.test(self.fullName())) {
                        validate.setError(leadUsername, 'Name cannot be more than 50 characters');
                        isValid = false;
                    }
                    else if (nameLength >= 1) {
                        validate.hideError(leadUsername);
                        isValid = true;
                    }
                }
                else {
                    validate.setError(leadUsername, 'Please enter your name');
                    isValid = false;
                }
                return isValid;
            };

            self.validateEmailId = function () {
                var regMaxLen = /^[A-z0-9._+-@@]{1,50}$/;
                leadEmailId = emailid;
                var isValid = true,
                    emailVal = leadEmailId.val(),
                    reEmail = /^[A-z0-9._+-]+@@[A-z0-9.-]+\.[A-z]{2,6}$/;
                if (self.emailOption() == 'Required' && emailVal == "") {
                    validate.setError(leadEmailId, 'Please enter email id');
                    isValid = false;
                }
                else if (emailVal == "") {
                    isValid = true;
                }
                else if (!reEmail.test(emailVal)) {
                    validate.setError(leadEmailId, 'Invalid Email');
                    isValid = false;
                }
                else if (!regMaxLen.test(emailVal)) {
                    validate.setError(leadEmailId, 'Email cannot be more than 50 characters');
                    isValid = false;
                }
                return isValid;
            };


            self.validatePinCode = function () {
                var leadPinCode = $('#getPinCode'), isValid = true,
                    pinCodeValue = leadPinCode.val().trim(),
                    rePinCode = /^[1-9][0-9]{5}$/;

                if (pinCodeValue.indexOf(',') > 0)
                    pinCodeValue = pinCodeValue.substring(0, 6);

                if (pinCodeValue == "") {
                    validate.setError(leadPinCode, 'Please enter pincode');
                    isValid = false;
                }
                else if (!rePinCode.test(pinCodeValue)) {
                    validate.setError(leadPinCode, 'Invalid pincode');
                    isValid = false;
                }

                if (isValid) isValid &= self.checkPinCode(pinCodeValue);

                return isValid;
            };
            self.validateMobileNo = function () {
                leadMobileNo = mobile;
                var mobileVal = leadMobileNo.val();
                if (!validateMobileNo(mobileVal, self)) {
                    validate.setError(leadMobileNo, self.msg);
                    return false;
                }
                else {
                    validate.hideError(leadMobileNo);
                    return true;
                }
            };

            self.validateCity = function () {
                var isValid = true;
                eleCity = $("#city-select-element").find(".city-box-default");
                if (eleCity != null && self.cityId() != null) {
                    if (self.cityId() > 0) {
                        validateInputSelection.hideError(eleCity);
                        isValid = true;
                    }
                    else {
                        validateInputSelection.setError(eleCity, 'Select a city');
                        isValid = false;
                    }
                }
                else {
                    validateInputSelection.setError(eleCity, 'Select a city');
                    isValid = false;
                }

                return isValid;
            };

            self.validateBike = function () {
                var isValid = true;
                eleBike = $("#getLeadBike").find(".dealer-search-brand-form");
                if (eleBike != null && self.selectedBike() != null) {
                    if (self.selectedBike().model && self.selectedBike().model.modelId > 0) {
                        validateInputSelection.hideError(eleBike);
                        isValid = true;
                    }
                    else {
                        validateInputSelection.setError(eleBike, 'Select a bike');
                        isValid = false;
                    }
                }
                else {
                    validateInputSelection.setError(eleBike, 'Select a bike');
                    isValid = false;
                }

                return isValid;
            };

            self.submitCampaignLead = function (data, event) {

                var isValidCustomer = self.validateUserInfo(fullName, emailid, mobile);

                if (isValidCustomer && self.mfgCampaignId() > 0) {

                    if (!((self.pqId() && self.pqId() != 0) || (self.pqGUId() && self.pqGUId() != "")))
                        self.generatePQ(data, event);
                    self.ko_DealerName($('#ddlMfgDealers option:selected').text());
                    $('#processing').show();
                    var objCust = {
                        "dealerId": self.dealerId(),
                        "pqId": self.pqId(),
                        "pqguid": self.pqGUId(),
                        "name": self.fullName(),
                        "mobile": self.mobileNo(),
                        "email": self.emailId(),
                        "versionId": self.versionId(),
                        "cityId": self.cityId(),
                        "leadSourceId": self.leadSourceId(),
                        "pinCode": self.pincode() || 0,
                        "deviceId": getCookie('BWC'),
                        "campaignId": self.mfgCampaignId(),
                        "manufacturerDealerId": $('#ddlMfgDealers :selected').data('id'),
                        "manufacturerDealer": self.ko_DealerName(),
                        "bikeName": leadBikeName,
                        "dealerName": self.organizationName() ? self.organizationName() : self.dealerName(),
                        "sendLeadSMSCustomer": self.sendLeadSMSCustomer(),
                        "leadId":self.leadId(),
                        "platformId": @Model.PlatformId,
                        "pageId": @Model.PageId,
                        "emailOption": self.emailOption()
                    };
                    $.ajax({
                        type: "POST",
                        url: "/api/ManufacturerLead/",
                        data: ko.toJSON(objCust),
                        beforeSend: function (xhr) {
                            self.showLoader();
                            xhr.setRequestHeader('utma', getCookie('__utma'));
                            xhr.setRequestHeader('utmz', getCookie('_bwutmz'));
                        },
                        async: true,
                        contentType: "application/json",
                        dataType: 'json',
                        success: function (response) {
                            self.leadId(response);
                            $("#personalInfo,#otpPopup").hide();
                            $('#processing').hide();
                            $('#notify-response .notify-leadUser').text(self.fullName());
                            $('#notify-response').addClass('notify-response--active');
                            LeadPopupState.setFinalScreen();
                            if (self.cityRequired() && self.selectedCity()) {
                                SetCookieInDays("location", self.selectedCity().cityId + "_" + self.selectedCity().cityName, 365);
                            }
                            if(fbPixelLeadEvent)
                            {
                                fbq('track', fbPixelLeadEvent);
                            }
                        },
                        error: function (xhr, ajaxOptions, thrownError) {
                            $('#processing').hide();
                            $("#otpPopup").hide();
                            $('#contactDetailsPopup').removeClass('contact-detail--active');
                        },
                        complete: function (xhr, ajaxOptions, thrownError) {
                            self.hideLoader();
                        }
                    });

                    setPQUserCookie();
                }
            };

            self.setPinCodeSuggestion = function () {

                $.fn.hint = bwHint;
                $.fn.bw_autocomplete = bwAutoComplete;

                $("#getPinCode").bw_autocomplete({
                    source: 4,
                    recordCount: 3,
                    minLength: 2,
                    onClear: function () {
                        objPinCodes = new Object();
                    },
                    click: function (event, ui, orgTxt) {
                        if (self.selectedBike() && self.selectedBike().make && self.selectedBike().model) {
                            var keywrd = self.selectedBike().make.makeName + '_' + self.selectedBike().model.modelName + '_pinCode_' + $('#getPinCode').val();
                            dataLayer.push({ 'event': 'Bikewale_all', 'cat': 'LeadCapture_Popup', 'act': 'PinCode_Selected', 'lab': keywrd });
                        }
                        if (ui && ui.item) {
                            self.pincode(ui.item.payload.pinCode);
                        }
                        else {
                            self.pincode(0);
                        }

                    },
                    open: function (result) {
                        objPinCodes.result = result;
                    },
                    focusout: function () {
                        if ($('#getPinCode').find('li.ui-state-focus a:visible').text() != "") {
                            $('#errPinCodeSearch').hide();
                            focusedMakeModel = new Object();
                            focusedMakeModel = objPinCodes.result ? objPinCodes.result[$('li.ui-state-focus').index()] : null;
                        }
                        else {
                            $('#errPinCodeSearch').hide();
                        }
                    },
                    afterfetch: function (result, searchtext) {
                        if (result != undefined && result.length > 0 && searchtext.trim() != "") {
                            $('#errPinCodeSearch').hide();
                        }
                        else {
                            focusedMakeModel = null;
                            if (searchtext.trim() != "") {
                                $('#errPinCodeSearch').show();
                                self.pincode(0);
                            }
                        }
                    },
                    keyup: function () {
                        if ($('#getPinCode').val().trim() != '' && $('li.ui-state-focus a:visible').text() != "") {
                            focusedMakeModel = new Object();
                            focusedMakeModel = objPinCodes.result ? objPinCodes.result[$('li.ui-state-focus').index()] : null;
                            $('#errPinCodeSearch').hide();
                        } else {
                            if ($('#getPinCode').val().trim() == '') {
                                $('#errPinCodeSearch').hide();
                            }
                        }

                        if ($('#getPinCode').val().trim() == '' || e.keyCode == 27 || e.keyCode == 13) {
                            if (focusedMakeModel == null || focusedMakeModel == undefined) {
                                if ($('#getPinCode').val().trim() != '') {
                                    $('#errPinCodeSearch').show();
                                    self.pincode(0);
                                }
                            }
                            else {
                                $('#errPinCodeSearch').hide();
                            }

                        }
                    }
                }).autocomplete({ appendTo: $("#getPinCode").closest(".input-box") }).autocomplete("widget").addClass("pincode-autocomplete");
            };

            self.checkPinCode = function (pinCode) {
                isValid = false;
                $.ajax({
                    async: false,
                    type: "GET",
                    url: "/api/autosuggest/?source=4&inputText=" + pinCode + "&noofrecords=5",
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) {
                        if (data && data.suggestionList.length > 0) {
                            $('#getPinCode').val(data.suggestionList[0].text);
                            self.pincode(data.suggestionList[0].payload.pinCodeId);
                            isValid = true;
                        }
                        else {
                            validate.setError($('#getPinCode'), 'Invalid pincode');
                            self.pincode(0);
                            isValid = false;
                        }
                    }
                });

                return isValid;
            };

            self.setInputValues = function () {
                var inputBoxes = $('.personal-info-form-container .input-box');
                for (var i = 0; i < inputBoxes.length; i++) {
                    var item = $(inputBoxes[i]),
                    inputValue = item.find('input').val();

                    if (inputValue.length > 0) {
                        item.addClass('not-empty');
                    }

                }
            };

            self.showLoader = function () {
                $('#ub-ajax-loader').show();
            };

            self.hideLoader = function () {
                $('#ub-ajax-loader').hide();
            };

            self.triggerABTestGA = function (galabel) {
                try {
                    var abuser = getCookie("_bwtest"), pgSource = (gaObj ? gaObj.id : 0);
                    triggerGA("Lead_PopUP", "Lead_Success", abuser + "_" + pgSource + "_" + galabel || '');
                }
                catch (e) {
                    console.log(e.message)
                }
            };

        }

        function setuserDetails() {
            var cookieName = "_PQUser";
            if (cookieName != undefined && cookieName != null && cookieName != "" && cookieName != "-1") {
                var keyValue = document.cookie.match('(^|;) ?' + cookieName + '=([^;]*)(;|$)');
                var arr = keyValue ? keyValue[2].split("&") : null;
                return arr;
            }
        }

        function setPQUserCookie() {
            var val = dleadvm.fullName() + '&' + dleadvm.emailId() + '&' + dleadvm.mobileNo();
            SetCookie("_PQUser", val);
        }

        var setError = function (element, msg) {
            element.addClass("border-red").siblings("span.errorIcon, div.errorText").show();
            element.siblings("div.errorText").text(msg);
        };

        var hideError = function (element) {
            element.removeClass("border-red").siblings("span.errorIcon, div.errorText").hide();
        };

        function startLoading(ele) {
            try {
                var _self = $(ele).find(".progress-bar").css({ 'width': '0' }).show();
                _self.animate({ width: '100%' }, 500);
            }
            catch (e) { return };
        }

        function stopLoading(ele) {
            try {
                var _self = $(ele).find(".progress-bar");
                _self.stop(true, true).css({ 'width': '100%' }).fadeOut(1000);
            }
            catch (e) { return };
        }

        function setSelectedElement(_self, selectedElement) {
            _self.parent().prev("input[type='text']").val(selectedElement);
            $("#brandSearchBar").addClass('open').animate({ 'left': '100%' }, 500);
        };

        var agreementPolicyPopup = (function () {
            var policyPopup, closebtn, leadCapturePopup, container;

            function _setSelectors() {
                policyPopup = $('#policyPopup');
                closebtn = $('.policy-close-btn');
                leadCapturePopup = $('#leadCapturePopup');
                container = $('.policy-container');
            }

            function registerEvents() {
                _setSelectors();

                $('#visitor-agreement-link, #privacy-policy-link').on('click', function (e) {
                    e.preventDefault();
                    var containerId = $("#policyPopupContainer");
                    if ($(this).data('link') === 1) {
                        $.ajax({
                            type: "GET",
                            url: "/Privacy/PrivacyPolicy/",
                            contentType: "application/json",
                            dataType: "html",
                            success: function (data) {
                                containerId.html(data);
                            },
                            error: function () {
                                containerId.html("Page Not Found");
                            }
                        });
                    }
                    else if ($(this).data('link') === 2) {
                        $.ajax({
                            type: "GET",
                            url: "/Privacy/VisitorAgreement/",
                            contentType: "application/json",
                            dataType: "html",
                            success: function (data) {
                                containerId.html(data);
                            },
                            error: function () {
                                containerId.html("Page Not Found");
                            }
                        });
                    }
                    agreementPolicyPopup.open();
                });

                $('.policy-close-btn').on('click', function () {
                    if (policyPopup.is(':visible')) {
                        window.history.back();
                    }
                });

                container.on('scroll', function () {
                    if (container.scrollTop() == 0) {
                        $('.policy-container').removeClass('box-shadow-top');
                    }
                    else {
                        $('.policy-container').addClass('box-shadow-top');
                    }
                });

                $(window).on('popstate', function () {
                    if (policyPopup.is(':visible')) {
                        close();
                    }
                });
            }

            function open() {
                popup.lock();
                policyPopup.fadeIn(200);
                $('#policyPopupContainer').scrollTop(0);
                history.pushState('agreementpopup', '', '');
            }

            function close() {
                policyPopup.fadeOut(200);
                popup.unlock();
            }

            return {
                registerEvents: registerEvents,
                open: open,
                close: close
            }
        })();
        var LeadPopupStateEnum = {"Open":1, "Close":2, "Final":3};
        var LeadPopupState = (function() {
            var leadCapturePopup = document.getElementById('leadCapturePopup');

            function close() {
                $(leadCapturePopup).removeClass('lead-popup--active');
                $("#notify-response").removeClass('notify-response--active');
                $('.additional-screen').removeClass('dealers--active');
                this.status = LeadPopupStateEnum.Close;
            }
            function open() {
                $(leadCapturePopup).addClass('lead-popup--active');
                $('.additional-screen').removeClass('additional-screen--active');
                $("#notify-response").removeClass('notify-response');
                $('#contactDetailsPopup').addClass('contact-detail--active');
                dleadvm.selectedMLADealerIds([]);
                this.status = LeadPopupStateEnum.Open;
            }
            function setFinalScreen() {
                $('.additional-screen').addClass('additional-screen--active');
                $('#contactDetailsPopup').removeClass('contact-detail--active');
                this.status = LeadPopupStateEnum.Final;
            }

            return {
                close: close,
                open: open,
                setFinalScreen: setFinalScreen,
                status: status
            }
        })();

        docReady(function () {
            windowScreen = {
                htmlElement: $('html'),

                bodyElement: $('body'),

                lock: function () {

                    if ($(document).height() > $(window).height()) {
                        var windowScrollTop = windowScreen.htmlElement.scrollTop() ? windowScreen.htmlElement.scrollTop() : windowScreen.bodyElement.scrollTop();
                        if (windowScrollTop < 0) {
                            windowScrollTop = 0;
                        }
                        windowScreen.htmlElement.addClass('lock-browser-scroll').css('top', -windowScrollTop);
                    }
                },

                unlock: function () {
                    var windowScrollTop = parseInt(windowScreen.htmlElement.css('top'));

                    windowScreen.htmlElement.removeClass('lock-browser-scroll');
                    $('html, body').scrollTop(-windowScrollTop);
                }
            };
            $('#contactDetailsPopup .dropdown-select-wrapper').on('click', '.dropdown-label', function () {
                leadCapturePopup.animate({ scrollTop: leadCapturePopup[0].scrollHeight });
            });

            leadBtnBookNow = $(".leadcapturebtn"), leadCapturePopup = $("#leadCapturePopup"), leadBike = $("#getLeadBike");
            fullName = $("#getFullName"), emailid = $("#getEmailID"), mobile = $("#getMobile"), detailsSubmitBtn = $("#user-details-submit-btn");
            if(FbPixelEvent)
            {
                fbPixelLeadEvent = FbPixelEvent.lead;
            }
            leadBtnBookNow.on('click', function () {
                $('#selectedbike').html('Select a bike<sup>*</sup>');
                dleadvm.selectedBike(null);
                LeadPopupState.open();
                @if (Model.IsMLAActive && !Model.IsManufacturerCampaign)
            {
                <text>
                if(gaObj.id == gaEnum.Model_Page || gaObj.id == gaEnum.DealerPriceQuote_Page)
                {
                    triggerNonInteractiveGA(gaObj.name,"MLA_Eligible_Lead_Popup_Shown",  "@Model.BikeName" + "_" +  "@Model.City" + "_" + "@Model.Area");
                }
                </text>
            }
                // $("div#contactDetailsPopup").show();
                $('#otherDealer').show();
                appendState('leadCapture');
                windowScreen.lock();
            });

            function closeLeadPopup() {
                LeadPopupState.close();
                $('body').removeClass('lock-browser-scroll');
                windowScreen.unlock();
            }

            $(".leadCapture-close-btn").on("click", function(event) {
                dleadvm.triggerCloseBtnGA(event);
                closeLeadPopup();
                triggerGA("Lead_PopUP", "Close", "");
            });

            $(".blackOut-window, .dealers__skip-btn, .dealers__submit-btn").on("click mouseup", function () {
                closeLeadPopup();
            });

            @if (Model.IsApp) {
                <text>
            $(".inapp-leadCapture-close-btn").on("click", function() {
                Android.closeForm();
            });
            </text>
            }
            if(document.querySelector('.offers-action__more-link') != null){
                document.querySelector('.offers-action__more-link').addEventListener('click', function(){
                    document.querySelector('.offers__body').classList.add('offers-expanded');
                });
            }

            $(document).on('click', '#notifyOkayBtn', function () {
                @if (Model.IsApp) {
                    <text>
                $(".inapp-leadCapture-close-btn").trigger("click");
                </text>
                    }
                    else
                    {
                        <text>
                closeLeadPopup();
                </text>
                    }
            });

            $(document).on('keydown', function (e) {
                if (e.keyCode === 27) {
                    @if (Model.IsApp) {
                            <text>
                    leadCapturePopup.find(".inapp-leadCapture-close-btn").trigger("click");
                    </text>
                        }
                        else
                        {
                            <text>
                    closeLeadPopup();
                    </text>
                        }

                }
            });

            $("#getFullName").on("focus", function () {
                validate.onFocus($(this), leadCapturePopup);
            });

            $(document).on("focus", "#getPinCode", function () {
                validate.onFocus($(this), leadCapturePopup);
                prevPinCode = $(this).val().trim().substring(0, 6);
            });

            $("#getEmailID").on("focus", function () {
                validate.onFocus($(this), leadCapturePopup);
                prevEmail = $(this).val().trim();
            });

            $("#getMobile").on("focus", function () {
                validate.onFocus($(this), leadCapturePopup);
                prevMobile = $(this).val().trim();
            });

            $("#getFullName").on("blur", function () {
                validate.onBlur($(this));
            });

            $(document).on("blur", "#getPinCode", function () {
                validate.onBlur($(this));
                var pincode = $("#getPinCode");
                var pc = pincode.val().trim();

                if (pc.length > 0 && !(/^[1-9][0-9]{5}$/.test(pc))) {
                    validate.setError($("#getPinCode"), 'Invalid pincode');
                    if (dleadvm.validatePinCode(pincode)) {
                        dleadvm.IsVerified(false);
                        validate.hideError(pincode);
                    }
                }

            });

            $("#getEmailID").on("blur", function () {
                validate.onBlur($(this));
                if (prevEmail != $(this).val().trim()) {
                    if (dleadvm.validateEmailId($(this))) {
                        dleadvm.IsVerified(false);
                    }
                }
            });

            $("#getMobile").on("blur", function () {
                validate.onBlur($(this));
                if (prevMobile != $(this).val().trim()) {
                    if (dleadvm.validateMobileNo($(this))) {
                        dleadvm.IsVerified(false);
                    }
                }
            });

            $(document).on('click', '#templist li', function () {
                validate.setError($('#ddlMfgDealers'), '');
            });
            dleadvm = new leadModel();
            ko.applyBindings(dleadvm, document.getElementById("leadCapturePopup"));
            dleadvm.setInputValues();

            if ($("#getPinCode") && $("#getPinCode").length > 0) {
                dleadvm.setPinCodeSuggestion();
            }

            leadCapturePopup.on('click', ".dealer-search-brand", function () {
                $('.dealer-brand-wrapper').show();
                $("#brandSearchBar").addClass('open').animate({ 'left': '0px' }, 500);
                $("#brandSearchBar").find(".user-input-box").animate({ 'left': '0px' }, 500);
                $("#assistanceBrandInput").focus();
            });

            leadCapturePopup.on("click", "#sliderBrandList li", function () {
                var _self = $(this),
                selectedElement = _self.text();
                setSelectedElement(_self, selectedElement);
                _self.addClass('activeBrand').siblings().removeClass('activeBrand');
                $(".dealer-search-brand-form").addClass('selection-done').find("span").text(selectedElement);
                $("#brandSearchBar").find(".user-input-box").animate({ 'left': '100%' }, 500);
                validateInputSelection.hideError($(".dealer-search-brand-form"));
            });

            leadCapturePopup.on("click", ".dealer-brand-wrapper .back-arrow-box", function () {
                $("#brandSearchBar").removeClass("open").animate({ 'left': '100%' }, 500);
                $("#brandSearchBar").find(".user-input-box").animate({ 'left': '100%' }, 500);
            });

            /* form validation */
            validate = {
                setError: function (element, message) {
                    var elementLength = element.val().length,
                        errorTag = element.siblings('span.error-text');

                    errorTag.show().text(message);
                    if (!elementLength) {
                        element.closest('.input-box').removeClass('not-empty').addClass('invalid');
                    }
                    else {
                        element.closest('.input-box').addClass('not-empty invalid');
                    }
                },

                hideError: function (element) {
                    element.closest('.input-box').removeClass('invalid').addClass('not-empty');
                    element.siblings('span.error-text').text('').hide();
                },

                onFocus: function (inputField, popupContainer) {
                    var inputBox = inputField.closest('.input-box');

                    if (inputBox.hasClass('invalid')) {
                        validate.hideError(inputField);
                    }

                    popupContainer.animate({ scrollTop: inputBox.offset().top - 20 });
                },

                onBlur: function (inputField) {
                    var inputLength = inputField.val().length;
                    if (!inputLength) {
                        inputField.closest('.input-box').removeClass('not-empty');
                    }
                    else {
                        inputField.closest('.input-box').addClass('not-empty');
                    }
                }
            };

            validateInputSelection = {
                setError: function (element, message) {
                    var errorTag = element.siblings('span.error-text');
                    element.closest('.input-select-box,.slideIn-input-box').addClass('invalid');
                    errorTag.text(message).show();
                },

                hideError: function (element) {
                    element.closest('.input-select-box,.slideIn-input-box').removeClass('invalid');
                    element.siblings('span.error-text').text('').hide();
                }
            };

            brandSearchBar = $("#brandSearchBar"), dealerSearchBrand = $(".dealer-search-brand"), dealerSearchBrandForm = $(".dealer-search-brand-form");

            // register agreement and privacy policy popup events
            agreementPolicyPopup.registerEvents();


        });



    </script>

    if (Model.CityId <= 0)
    {
        <link href="@String.Format("/UI/m/css/leadcapture.css?{1}", Bikewale.Utility.BWConfiguration.Instance.StaticUrl, Bikewale.Utility.BWConfiguration.Instance.StaticFileVersion)" rel="stylesheet" type="text/css" />
    }



}