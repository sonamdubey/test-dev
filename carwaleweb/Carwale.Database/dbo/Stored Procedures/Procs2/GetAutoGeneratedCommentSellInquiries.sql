IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'[dbo].[GetAutoGeneratedCommentSellInquiries]') 
    AND xtype IN (N'P')
)
    DROP PROCEDURE [dbo].[GetAutoGeneratedCommentSellInquiries]
GO

	
-- =============================================  
-- Author:  Manish  
-- Create date: 29-04-2014 
-- Details: SP will return the autogenerated comment for sell inquiries.
-- =============================================  
CREATE PROCEDURE [dbo].[GetAutoGeneratedCommentSellInquiries]  @CarMakeYear         AS DATETIME, 
                                                              @Kms                 AS INT, 
                                                              @OverAllCondition    AS VARCHAR(100), 
                                                              @NoOfOwner           AS VARCHAR(50),
                                                              @CarVersionId        AS INT,
															  @CarColour           AS VARCHAR(100),
															  @CityId              AS INT,
															  @CertificationId     AS INT,
															  @AutomatedComment    AS VARCHAR(MAX) OUTPUT
                                          
     AS           
		  BEGIN
		     
			 DECLARE @TransmissionType INT,
			         @CarFuelType INT,
					 @FuelName VARCHAR(30),
					 @TotalConditionNeedtoTrue TINYINT=0,
					 @CityName VARCHAR(30)

             SELECT @TransmissionType=CarTransmission,
			        @CarFuelType=CarFuelType,
					@FuelName=CF.FuelType
			 FROM CarVersions AS CV WITH (NOLOCK) 
			 JOIN CarFuelType AS CF WITH (NOLOCK) ON CV.CarFuelType=CF.FuelTypeId
			 WHERE Id=@CarVersionId




			 SET @AutomatedComment=''


			IF ( (ABS(DATEDIFF(MM,@CarMakeYear,GETDATE()))/12.000<=2) AND @Kms <15000 AND @TotalConditionNeedtoTrue<5 )
			BEGIN 
			   
			   SELECT TOP 1  @AutomatedComment=@AutomatedComment+CommentTags   
			   FROM UsedCarAutoGeneratedTags WITH (NOLOCK) 
			   WHERE UsedCarAutoGeneratedTagsId IN (1,2,3)
			   ORDER BY NEWID()

			   SET @TotalConditionNeedtoTrue=@TotalConditionNeedtoTrue+1

			END

			IF ( @TotalConditionNeedtoTrue<5 AND ( @OverAllCondition='Good' OR  @OverAllCondition='Excellent') )
			BEGIN 
			   
			   SELECT TOP 1 @AutomatedComment=@AutomatedComment+CommentTags   
			   FROM UsedCarAutoGeneratedTags WITH (NOLOCK) 
			   WHERE UsedCarAutoGeneratedTagsId IN (4,5,6)
			   ORDER BY NEWID()

			   SET @TotalConditionNeedtoTrue=@TotalConditionNeedtoTrue+1

			END 

			IF ( @TotalConditionNeedtoTrue<5 AND  ltrim(rtrim(@NoOfOwner))='First Owner' )
			BEGIN 
			   
			   SELECT TOP 1 @AutomatedComment=@AutomatedComment+CommentTags   
			   FROM UsedCarAutoGeneratedTags WITH (NOLOCK) 
			   WHERE UsedCarAutoGeneratedTagsId IN (7,8,9)
			   ORDER BY NEWID()

			   SET @TotalConditionNeedtoTrue=@TotalConditionNeedtoTrue+1

			END 

			IF ( @TotalConditionNeedtoTrue<5 AND  @TransmissionType=1 )  ---transmission automatic
			BEGIN 
			   
			   SELECT TOP 1 @AutomatedComment=@AutomatedComment+CommentTags   
			   FROM UsedCarAutoGeneratedTags WITH (NOLOCK) 
			   WHERE UsedCarAutoGeneratedTagsId IN (10)
			   ORDER BY NEWID()

			   SET @TotalConditionNeedtoTrue=@TotalConditionNeedtoTrue+1

			END 

		
			IF ( @TotalConditionNeedtoTrue<5 AND ( @CarFuelType=2 OR @CarFuelType=3 OR @CarFuelType=4) )  --Fuel type diesel,lpg,cng only
			BEGIN 
			   
			   SELECT TOP 1 @AutomatedComment=@AutomatedComment+CommentTags+' '+@FuelName +'.'
			   FROM UsedCarAutoGeneratedTags WITH (NOLOCK) 
			   WHERE UsedCarAutoGeneratedTagsId IN (11,12,13)
			   ORDER BY NEWID()

			   SET @TotalConditionNeedtoTrue=@TotalConditionNeedtoTrue+1

			END 

			IF (@TotalConditionNeedtoTrue<5 
			     AND (@CarColour IS NOT NULL OR @CarColour <>'')
			   )
			BEGIN

			   SELECT TOP 1 @AutomatedComment=@AutomatedComment+' '+UPPER(LEFT(@CarColour,1))+LOWER(SUBSTRING(@CarColour,2,LEN(@CarColour)))  +' '+CommentTags
			   FROM UsedCarAutoGeneratedTags WITH (NOLOCK) 
			   WHERE UsedCarAutoGeneratedTagsId IN (14)
			   ORDER BY NEWID()

			   SET @TotalConditionNeedtoTrue=@TotalConditionNeedtoTrue+1


			 END 
			
			
			IF (@TotalConditionNeedtoTrue<5 )
			BEGIN
			   
			   SELECT @CityName=Name FROM Cities WITH (NOLOCK) WHERE ID=@CityId

			   SELECT TOP 1 @AutomatedComment=@AutomatedComment+' '+CommentTags+' '+@CityName+'.'
			   FROM UsedCarAutoGeneratedTags WITH (NOLOCK) 
			   WHERE UsedCarAutoGeneratedTagsId IN (19,20,21)
			   ORDER BY NEWID()

			   SET @TotalConditionNeedtoTrue=@TotalConditionNeedtoTrue+1


			 END 

			 IF (@TotalConditionNeedtoTrue<5 AND @CertificationId IS NOT NULL AND @CertificationId <>-1)
			BEGIN
			   
			   SELECT TOP 1 @AutomatedComment=@AutomatedComment+CommentTags
			   FROM UsedCarAutoGeneratedTags WITH (NOLOCK) 
			   WHERE UsedCarAutoGeneratedTagsId IN (15)
			   ORDER BY NEWID()

			   SET @TotalConditionNeedtoTrue=@TotalConditionNeedtoTrue+1


			 END 

			 IF (@TotalConditionNeedtoTrue<5 )
			BEGIN
			   
			   SELECT TOP 1 @AutomatedComment=@AutomatedComment+' '+CommentTags
			   FROM UsedCarAutoGeneratedTags WITH (NOLOCK) 
			   WHERE UsedCarAutoGeneratedTagsId IN (16,17,18)
			   ORDER BY NEWID()

			   SET @TotalConditionNeedtoTrue=@TotalConditionNeedtoTrue+1


			 END 


		   
		  END 
  
  